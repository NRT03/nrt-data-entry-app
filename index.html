<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.R.T. Data Entry App</title>
    
    <link rel="manifest" href="manifest.json">
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(
                    registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    },
                    err => {
                        console.log('Service Worker registration failed:', err);
                    }
                );
            });
        }
    </script>
    
    <style>
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --primary-color: #3d74b6;
            --accent-color: #eac8a6;
            --danger-color: #dc3c22;
            --success-color: #10b981;
            --info-color: #fcd34d;
        }
        
        .dark {
            --bg-color: #111827;
            --text-color: #f3f4f6;
            --card-bg: #1f2937;
            --border-color: #374151;
            --primary-color: #60a5fa;
            --accent-color: #d68b55;
            --danger-color: #f87171;
            --success-color: #4ade80;
            --info-color: #fcd34d;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            padding: 1rem;
            transition: background-color 0.3s, color 0.3s;
        }

        .max-w-2xl {
            max-width: 42rem;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        header {
            text-align: center;
        }

        h1, h2, h3 {
            font-weight: bold;
            color: var(--text-color);
        }
        
        h1 { font-size: 1.875rem; }
        h2 { font-size: 1.25rem; }
        h3 { font-size: 1.125rem; }

        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .bg-white { background-color: var(--card-bg); }

        .form-view, .dashboard-view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-view {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
        }

        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .gap-4 { gap: 1rem; }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }

        .bg-primary { background-color: var(--primary-color); color: white; }
        .bg-primary:hover { background-color: #2d5f99; }
        .bg-accent { background-color: var(--accent-color); color: white; }
        .bg-accent:hover { background-color: #d6b797; }
        .bg-gray-300 { background-color: #d1d5db; color: #1f2937; }
        .bg-gray-300:hover { background-color: #9ca3af; }
        .bg-danger { background-color: var(--danger-color); color: white; }
        .bg-danger:hover { background-color: #b0301a; }
        
        .hidden { display: none; }
        .flex { display: flex; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .justify-end { justify-content: flex-end; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }

        .notification-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .notification {
            padding: 0.75rem;
            border-radius: 0.375rem;
            color: white;
            animation: fadein 0.5s, fadeout 0.5s 3.5s;
        }

        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }

        @keyframes fadein { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeout { from { opacity: 1; } to { opacity: 0; transform: translateY(20px); } }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .modal-box {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 24rem;
            width: 90%;
        }

        .modal-action {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        .invalid-field {
            border-color: var(--danger-color);
            background-color: #fee2e2;
        }

        /* Styles for the receipt JPEG */
        .receipt-container {
            padding: 1rem;
            border: 2px solid black;
            font-family: monospace;
            background-color: white;
            color: black;
            width: 300px;
            box-sizing: border-box;
        }
        .receipt-header { text-align: center; border-bottom: 1px dashed black; padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
        .receipt-header h1 { margin: 0; font-size: 1.2rem; }
        .receipt-header p { margin: 0; font-size: 0.8rem; }
        .receipt-details p { margin: 0; font-size: 0.9rem; line-height: 1.2; }
        .receipt-total { border-top: 1px dashed black; margin-top: 0.5rem; padding-top: 0.5rem; }
        .receipt-total p { margin: 0; font-size: 0.9rem; font-weight: bold; }
        .receipt-signature-box { border-top: 1px dashed black; margin-top: 1rem; padding-top: 0.5rem; text-align: center; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-gray-200 text-gray-900 font-sans p-4 dark:bg-gray-900 dark:text-gray-100">

    <div class="max-w-2xl mx-auto space-y-6">

        <header class="text-center">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-50">N.R.T. Data Entry App</h1>
            <p class="text-gray-600 dark:text-gray-400">Manage your sales data effortlessly</p>
        </header>

        <main class="space-y-6">

            <button id="toggle-view-btn" class="w-full bg-accent hover:bg-[#d6b797] text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out">
                Switch to Dashboard
            </button>

            <div id="form-view" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md space-y-4">
                <h2 class="text-xl font-bold text-center">Add New Sales Entry</h2>

                <form id="sales-form" class="space-y-4">
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label for="date" class="block text-sm font-medium">Date</label>
                            <input type="date" id="date" name="date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" required>
                        </div>
                        <div class="space-y-1">
                            <label for="storeName" class="block text-sm font-medium">Store Name</label>
                            <select id="storeName" name="storeName" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" required>
                                <option value="" disabled selected>Select a store</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label for="mobileNumber" class="block text-sm font-medium">Mobile Number</label>
                            <input type="tel" id="mobileNumber" name="mobileNumber" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" required>
                            <p id="mobile-error" class="text-sm text-danger mt-1 hidden">Please enter a valid 11-digit number.</p>
                        </div>
                        <div class="space-y-1">
                            <label for="invoiceNumber" class="block text-sm font-medium">Invoice Number</label>
                            <input type="text" id="invoiceNumber" name="invoiceNumber" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                        </div>
                        <div class="space-y-1">
                            <label for="gadgetType" class="block text-sm font-medium">Gadget Type</label>
                            <select id="gadgetType" name="gadgetType" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" required>
                                <option value="" disabled selected>Select a gadget type</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label for="modelName" class="block text-sm font-medium">Model Name</label>
                            <input type="text" id="modelName" name="modelName" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                        </div>
                        <div class="space-y-1">
                            <label for="quantity" class="block text-sm font-medium">Quantity</label>
                            <input type="number" id="quantity" name="quantity" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" required>
                        </div>
                        <div class="space-y-1">
                            <label for="sellingPrice" class="block text-sm font-medium">Selling Price (BDT)</label>
                            <input type="number" id="sellingPrice" name="sellingPrice" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" step="0.01" required>
                        </div>
                        <div class="space-y-1 md:col-span-2">
                            <label for="totalRevenue" class="block text-sm font-medium">Total Revenue (BDT)</label>
                            <input type="number" id="totalRevenue" name="totalRevenue" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-700 cursor-not-allowed" step="0.01" readonly>
                        </div>
                        <div class="space-y-1 md:col-span-2">
                            <label for="due" class="block text-sm font-medium">Due (BDT)</label>
                            <input type="number" id="due" name="due" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" step="0.01">
                        </div>
                        <div class="flex items-center md:col-span-2">
                            <input type="checkbox" id="keep-shop-info" class="h-4 w-4 text-primary rounded focus:ring-blue-500">
                            <label for="keep-shop-info" class="ml-2 block text-sm font-medium">Keep shop info for next entry</label>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 justify-end">
                        <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 rounded-md text-white font-semibold hidden">Cancel Edit</button>
                        <button type="button" id="clear-form-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md text-gray-800 font-semibold">Clear Form</button>
                        <button type="submit" id="submit-btn" class="px-4 py-2 bg-primary hover:bg-[#2d5f99] rounded-md text-white font-semibold">Submit</button>
                    </div>
                </form>

                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold">Manage Stores and Gadgets</h3>
                        <div class="flex space-x-4">
                            <button id="manage-stores-toggle" class="manage-toggle-btn text-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0a2 2 0 012-2h4a2 2 0 012 2m-2 2V6M5 13V9a2 2 0 012-2m0 0a2 2 0 012-2h4a2 2 0 012 2m-2 2V6M5 13v2a2 2 0 002 2m0 0a2 2 0 002 2h4a2 2 0 002-2m0 0v-2" />
                                </svg>
                            </button>
                            <button id="manage-gadgets-toggle" class="manage-toggle-btn text-danger">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 1 012 2v3m-4-3a2 2 1 004 0m-4 0a2 2 1 01-2 2v3m-4-3a2 2 1 01-2 2v3m12-3a2 2 1 01-2-2v3m0 0V9a2 2 0 00-2-2h-4a2 2 0 00-2 2v10m-2-5h10m-12-3a2 2 1 012 2v3m0 0V9a2 2 0 00-2-2h-4a2 2 0 00-2 2v10m-2-5h10m-12-3a2 2 1 012 2v3m0 0V9a2 2 0 00-2-2h-4a2 2 0 00-2 2v10m-2-5h10m-12-3a2 2 1 012 2v3m0 0V9a2 2 0 00-2-2h-4a2 2 0 00-2 2v10m-2-5h10m-12-3a2 2 1 012 2v3m0 0V9a2 2 0 00-2-2h-4a2 2 0 00-2 2v10m-2-5h10" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="manage-stores-container" class="mt-4 hidden space-y-2">
                        <h4 class="text-sm font-bold">Manage Stores</h4>
                        <div class="flex space-x-2">
                            <input type="text" id="new-store-input" class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" placeholder="New Store Name">
                            <button type="button" id="add-store-btn" class="p-2 bg-primary text-white rounded-md hover:bg-[#2d5f99] disabled:bg-gray-400" disabled>Add</button>
                        </div>
                        <div id="store-list" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div>
                    </div>

                    <div id="manage-gadgets-container" class="mt-4 hidden space-y-2">
                        <h4 class="text-sm font-bold">Manage Gadgets</h4>
                        <div class="flex space-x-2">
                            <input type="text" id="new-gadget-input" class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" placeholder="New Gadget Type">
                            <button type="button" id="add-gadget-btn" class="p-2 bg-primary text-white rounded-md hover:bg-[#2d5f99] disabled:bg-gray-400" disabled>Add</button>
                        </div>
                        <div id="gadget-list" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-200 dark:border-gray-700 mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Sales Entries</h2>
                        <div class="flex space-x-2">
                            <button id="view-dues-btn" class="px-2 py-1 bg-info hover:bg-[#eab308] rounded-md text-gray-800 text-sm font-semibold">View Dues</button>
                            <button id="export-btn" class="px-2 py-1 bg-primary hover:bg-[#2d5f99] rounded-md text-white text-sm font-semibold">Export to CSV</button>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2 mb-4">
                        <input type="text" id="search-input" placeholder="Search by mobile, invoice, store..." class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                        <button id="clear-search-btn" class="p-2 bg-gray-300 hover:bg-gray-400 rounded-md text-gray-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <div id="entries-list" class="space-y-4">
                        </div>
                </div>
            </div>

            <div id="dashboard-view" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md space-y-6 hidden">
                <h2 class="text-xl font-bold text-center">Sales Dashboard</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-[#fbf5de] dark:bg-[#eac8a6] p-4 rounded-lg shadow-sm">
                        <h3 class="text-sm text-gray-700 dark:text-gray-900 font-semibold">Total Sales</h3>
                        <p id="total-sales" class="text-xl font-bold text-gray-900 dark:text-gray-900 mt-1">BDT 0.00</p>
                    </div>
                    <div class="bg-[#eac8a6] dark:bg-[#d68b55] p-4 rounded-lg shadow-sm">
                        <h3 class="text-sm text-gray-700 dark:text-gray-900 font-semibold">Total Due</h3>
                        <p id="total-due" class="text-xl font-bold text-gray-900 dark:text-gray-900 mt-1">BDT 0.00</p>
                    </div>
                    <div class="bg-[#fbf5de] dark:bg-[#eac8a6] p-4 rounded-lg shadow-sm">
                        <h3 class="text-sm text-gray-700 dark:text-gray-900 font-semibold">Total Shops</h3>
                        <p id="total-shops" class="text-xl font-bold text-gray-900 dark:text-gray-900 mt-1">0</p>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-center mb-2">Revenue by Date</h3>
                        <canvas id="revenue-chart"></canvas>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-center mb-2">Top Gadgets</h3>
                        <canvas id="gadget-sales-chart"></canvas>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-center mb-2">Sales by Store</h3>
                        <canvas id="store-sales-chart"></canvas>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="custom-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 id="modal-title" class="text-lg font-bold"></h3>
            <p id="modal-text" class="py-4"></p>
            <div class="modal-action">
                <button id="modal-confirm-btn" class="px-4 py-2 bg-primary hover:bg-[#2d5f99] rounded-md text-white font-semibold">OK</button>
            </div>
        </div>
    </div>
    
    <div class="notification-container"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Keys for Local Storage
            const SALES_KEY = 'chinoMartSales';
            const STORES_KEY = 'chinoMartStores';
            const GADGETS_KEY = 'chinoMartGadgets';
            const OFFLINE_QUEUE_KEY = 'chinoMartOfflineQueue';
            const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwOyZ_ehxURDo1giZ9eFI1fMZnxkhzUOTFIJkGAze2YDU4xDoRACSaTW1uNdsFNHHBH/exec';

            // Helper function to save data to Local Storage
            const saveDataToLocalStorage = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving to Local Storage', e);
                    showNotification('Could not save data to your device. Local Storage might be full or disabled.', 'error');
                }
            };

            // Helper function to load data from Local Storage
            const loadDataFromLocalStorage = (key, defaultData) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultData;
                } catch (e) {
                    console.error('Error loading from Local Storage', e);
                    return defaultData;
                }
            };

            // State for the application, loaded from Local Storage
            let allSalesEntries = loadDataFromLocalStorage(SALES_KEY, []);
            let allStoreNames = loadDataFromLocalStorage(STORES_KEY, ['Hasan Tel', 'Classic Mobile', 'Big Rock', 'Shahenshah Gadgets', 'Students Gadgets', 'Phone Store', 'Telephonic', 'Rakib Telecom', 'i-Club', 'Navigation Center', 'Talha Telecom', 'Kajol Electronics', 'Talukdar Telecom', 'Company Store', 'Talukdar Telecom 2', 'Samart Sec & Tech', 'Bismillah Telecom', 'Sajol Telecom']);
            let allGadgetTypes = loadDataFromLocalStorage(GADGETS_KEY, ['Phone Charger', 'Ear Buds', 'USB Cable', 'Ear Phone']);
            let offlineQueue = loadDataFromLocalStorage(OFFLINE_QUEUE_KEY, []);
            let editingIndex = -1; // -1 means no entry is being edited

            // DOM elements
            const form = document.getElementById('sales-form');
            const entriesList = document.getElementById('entries-list');
            const quantityInput = document.getElementById('quantity');
            const sellingPriceInput = document.getElementById('sellingPrice');
            const totalRevenueInput = document.getElementById('totalRevenue');
            const exportBtn = document.getElementById('export-btn');
            const manageStoresToggleBtn = document.getElementById('manage-stores-toggle');
            const manageStoresContainer = document.getElementById('manage-stores-container');
            const newStoreInput = document.getElementById('new-store-input');
            const addStoreBtn = document.getElementById('add-store-btn');
            const storeList = document.getElementById('store-list');
            const manageGadgetsToggleBtn = document.getElementById('manage-gadgets-toggle');
            const manageGadgetsContainer = document.getElementById('manage-gadgets-container');
            const newGadgetInput = document.getElementById('new-gadget-input');
            const addGadgetBtn = document.getElementById('add-gadget-btn');
            const storeSelect = document.getElementById('storeName');
            const gadgetSelect = document.getElementById('gadgetType');
            const gadgetList = document.getElementById('gadget-list');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const customModal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const notificationContainer = document.querySelector('.notification-container');
            const toggleViewBtn = document.getElementById('toggle-view-btn');
            const formView = document.getElementById('form-view');
            const dashboardView = document.getElementById('dashboard-view');
            const submitBtn = document.getElementById('submit-btn');
            const clearFormBtn = document.getElementById('clear-form-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const viewDuesBtn = document.getElementById('view-dues-btn');
            const dateInput = document.getElementById('date');
            const mobileNumberInput = document.getElementById('mobileNumber');
            const keepShopInfoCheckbox = document.getElementById('keep-shop-info');

            // Dashboard Metrics
            const totalSalesEl = document.getElementById('total-sales');
            const totalDueEl = document.getElementById('total-due');
            const totalShopsEl = document.getElementById('total-shops');

            // Chart.js chart instances
            let revenueChart, gadgetSalesChart, storeSalesChart;

            // Helper function for custom alerts
            const customAlert = (message, onConfirmCallback = () => {}) => {
                modalTitle.textContent = 'Alert';
                modalText.textContent = message;
                customModal.classList.remove('hidden');
                modalConfirmBtn.onclick = () => {
                    customModal.classList.add('hidden');
                    onConfirmCallback();
                };
            };

            // Show a temporary notification
            const showNotification = (message, type = 'success') => {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notificationContainer.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 4000); // Notification disappears after 4 seconds
            };

            // Load theme from system preference
            const loadTheme = () => {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            };
            
            loadTheme();
            
            // Load and populate dropdowns from the local data
            const loadDropdowns = () => {
                storeSelect.innerHTML = '<option value="" disabled selected>Select a store</option>';
                allStoreNames.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    storeSelect.appendChild(option);
                });

                gadgetSelect.innerHTML = '<option value="" disabled selected>Select a gadget type</option>';
                allGadgetTypes.sort().forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    gadgetSelect.appendChild(option);
                });
            };

            // Render the management lists with edit and delete buttons
            const renderManagementList = (inputElement, listElement, items, type) => {
                const query = inputElement.value.toLowerCase();
                listElement.innerHTML = '';
                
                const filteredItems = items.filter(item => item.toLowerCase().includes(query));

                if (filteredItems.length === 0 && query !== '') {
                    listElement.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">No results found for "${query}".</p>`;
                } else if (filteredItems.length > 0) {
                    filteredItems.forEach(item => {
                        const listItem = document.createElement('div');
                        listItem.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                        listItem.innerHTML = `
                            <span contenteditable="true" class="editable-item text-gray-900 dark:text-gray-50 px-2 py-1" data-old-value="${item}">${item}</span>
                            <div>
                                <button type="button" class="delete-item-btn text-danger hover:text-[#b0301a] ml-2" data-item="${item}" data-type="${type}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </div>
                        `;
                        listElement.appendChild(listItem);
                    });
                }
                
                listElement.querySelectorAll('.editable-item').forEach(itemSpan => {
                    itemSpan.addEventListener('blur', (e) => {
                        const oldItem = e.target.getAttribute('data-old-value');
                        const newItem = e.target.textContent.trim();
                        const isStore = type === 'store';
                        
                        if (newItem === '' || newItem === oldItem) {
                            e.target.textContent = oldItem;
                            return;
                        }
                        
                        const itemsArray = isStore ? allStoreNames : allGadgetTypes;
                        if (itemsArray.map(i => i.toLowerCase()).includes(newItem.toLowerCase())) {
                            customAlert(`"${newItem}" already exists. Please use a different name.`);
                            e.target.textContent = oldItem;
                            return;
                        }
                        
                        const index = itemsArray.indexOf(oldItem);
                        if (index > -1) {
                            itemsArray[index] = newItem;
                        }
                        
                        e.target.setAttribute('data-old-value', newItem);
                        
                        if (isStore) {
                            saveDataToLocalStorage(STORES_KEY, allStoreNames);
                        } else {
                            saveDataToLocalStorage(GADGETS_KEY, allGadgetTypes);
                        }
                        
                        loadDropdowns();
                        showNotification(`${oldItem} was updated to ${newItem}!`);
                    });
                });
                
                listElement.querySelectorAll('.delete-item-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const itemToDelete = e.target.getAttribute('data-item') || e.target.closest('button').getAttribute('data-item');
                        const isStore = e.target.getAttribute('data-type') === 'store' || e.target.closest('button').getAttribute('data-type') === 'store';
                        
                        customAlert(`Are you sure you want to delete "${itemToDelete}"?`, () => {
                            if (isStore) {
                                allStoreNames = allStoreNames.filter(name => name !== itemToDelete);
                                saveDataToLocalStorage(STORES_KEY, allStoreNames);
                                loadDropdowns();
                                renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                            } else {
                                allGadgetTypes = allGadgetTypes.filter(name => name !== itemToDelete);
                                saveDataToLocalStorage(GADGETS_KEY, allGadgetTypes);
                                loadDropdowns();
                                renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                            }
                            showNotification(`${itemToDelete} deleted successfully!`);
                        });
                    });
                });
            };

            const updateAddButtonState = (inputElement, buttonElement, items) => {
                const inputValue = inputElement.value.trim();
                const itemExists = items.map(item => item.toLowerCase()).includes(inputValue.toLowerCase());
                
                if (inputValue === '' || itemExists) {
                    buttonElement.disabled = true;
                } else {
                    buttonElement.disabled = false;
                }
            };
            
            addStoreBtn.addEventListener('click', () => {
                const newStore = newStoreInput.value.trim();
                if (newStore && !allStoreNames.map(name => name.toLowerCase()).includes(newStore.toLowerCase())) {
                    allStoreNames.push(newStore);
                    newStoreInput.value = '';
                    saveDataToLocalStorage(STORES_KEY, allStoreNames);
                    loadDropdowns();
                    renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                    updateAddButtonState(newStoreInput, addStoreBtn, allStoreNames);
                    showNotification('New store added!');
                } else {
                    customAlert(`"${newStore}" already exists or is invalid.`);
                }
            });

            addGadgetBtn.addEventListener('click', () => {
                const newGadget = newGadgetInput.value.trim();
                if (newGadget && !allGadgetTypes.map(type => type.toLowerCase()).includes(newGadget.toLowerCase())) {
                    allGadgetTypes.push(newGadget);
                    newGadgetInput.value = '';
                    saveDataToLocalStorage(GADGETS_KEY, allGadgetTypes);
                    loadDropdowns();
                    renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                    updateAddButtonState(newGadgetInput, addGadgetBtn, allGadgetTypes);
                    showNotification('New gadget type added!');
                } else {
                    customAlert(`"${newGadget}" already exists or is invalid.`);
                }
            });

            newStoreInput.addEventListener('input', () => {
                renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                updateAddButtonState(newStoreInput, addStoreBtn, allStoreNames);
            });
            newGadgetInput.addEventListener('input', () => {
                renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                updateAddButtonState(newGadgetInput, addGadgetBtn, allGadgetTypes);
            });

            manageStoresToggleBtn.addEventListener('click', () => {
                manageStoresContainer.classList.toggle('hidden');
                if (!manageStoresContainer.classList.contains('hidden')) {
                    renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                    updateAddButtonState(newStoreInput, addStoreBtn, allStoreNames);
                }
            });
            manageGadgetsToggleBtn.addEventListener('click', () => {
                manageGadgetsContainer.classList.toggle('hidden');
                if (!manageGadgetsContainer.classList.contains('hidden')) {
                    renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                    updateAddButtonState(newGadgetInput, addGadgetBtn, allGadgetTypes);
                }
            });

            const calculateTotalRevenue = () => {
                const quantity = parseFloat(quantityInput.value) || 0;
                const sellingPrice = parseFloat(sellingPriceInput.value) || 0;
                const totalRevenue = quantity * sellingPrice;
                totalRevenueInput.value = totalRevenue.toFixed(2);
            };

            quantityInput.addEventListener('input', calculateTotalRevenue);
            sellingPriceInput.addEventListener('input', calculateTotalRevenue);
            
            const downloadAsJpeg = (entry, filename) => {
                const receiptHtml = `
                    <div class="receipt-container">
                        <div class="receipt-header">
                            <h1>ChinoMart BD</h1>
                            <p>Money Receipt</p>
                        </div>
                        <div class="receipt-details">
                            <p><strong>Date:</strong> ${entry.date}</p>
                            <p><strong>Store:</strong> ${entry.storeName}</p>
                            <p><strong>Mobile:</strong> ${entry.mobileNumber}</p>
                            <p><strong>Invoice:</strong> ${entry.invoiceNumber}</p>
                            <p><strong>Gadget:</strong> ${entry.gadgetType} - ${entry.modelName}</p>
                            <p><strong>Quantity:</strong> ${entry.quantity}</p>
                            <p><strong>Price:</strong> BDT ${parseFloat(entry.sellingPrice).toFixed(2)}</p>
                        </div>
                        <div class="receipt-total">
                            <p><strong>Total:</strong> BDT ${parseFloat(entry.totalRevenue).toFixed(2)}</p>
                            <p><strong>Due:</strong> ${entry.due && parseFloat(entry.due) > 0 ? `<span class="text-danger font-bold">BDT ${parseFloat(entry.due).toFixed(2)}</span>` : 'Paid'}</p>
                        </div>
                        <div class="receipt-signature-box">
                            <p>Signature</p>
                        </div>
                    </div>
                `;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = receiptHtml;
                document.body.appendChild(tempDiv);
                
                const receiptElement = tempDiv.querySelector('.receipt-container');

                html2canvas(receiptElement, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    showNotification('Receipt downloaded as JPEG!');
                    
                    // Clean up the temporary element
                    tempDiv.remove();
                }).catch(error => {
                    console.error('Error generating JPEG:', error);
                    showNotification('Could not download the receipt. Please try again.', 'error');
                    
                    // Clean up in case of error as well
                    tempDiv.remove();
                });
            };

            const renderData = (data) => {
                entriesList.innerHTML = '';
                
                if (data.length === 0) {
                    entriesList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No matching entries found.</p>';
                    return;
                }

                data.forEach((entry, index) => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start';
                    entryDiv.innerHTML = `
                        <div>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Date:</strong> ${entry.date}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Store:</strong> ${entry.storeName}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Mobile:</strong> ${entry.mobileNumber}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Invoice:</strong> ${entry.invoiceNumber}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Gadget:</strong> ${entry.gadgetType} - ${entry.modelName}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Quantity:</strong> ${entry.quantity}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Price:</strong> BDT ${entry.sellingPrice}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Total:</strong> BDT ${entry.totalRevenue}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Due:</strong> ${entry.due && parseFloat(entry.due) > 0 ? `<span class="text-danger font-bold">BDT ${parseFloat(entry.due).toFixed(2)}</span>` : 'Paid'}</p>
                        </div>
                        <div class="flex space-x-2 mt-4 sm:mt-0">
                             <button type="button" class="download-jpeg-btn px-2 py-1 bg-primary hover:bg-[#2d5f99] rounded-md text-white text-xs font-semibold" data-index="${index}">
                                Download as JPEG
                            </button>
                             <button type="button" class="edit-btn px-2 py-1 bg-accent hover:bg-[#d6b797] rounded-md text-white text-xs font-semibold" data-index="${index}">
                                Edit
                            </button>
                            <button type="button" class="delete-btn px-2 py-1 bg-danger hover:bg-[#b0301a] rounded-md text-white text-xs font-semibold" data-index="${index}">
                                Delete
                            </button>
                        </div>
                    `;
                    entriesList.appendChild(entryDiv);
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToDelete = parseInt(e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index'));
                        customAlert('Are you sure you want to delete this sales entry?', () => {
                            allSalesEntries.splice(indexToDelete, 1);
                            saveDataToLocalStorage(SALES_KEY, allSalesEntries);
                            renderData(allSalesEntries);
                            refreshDashboardMetrics();
                            showNotification('Entry deleted successfully!');
                            if (dashboardView.classList.contains('hidden') === false) {
                                renderCharts();
                            }
                        });
                    });
                });
                
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToEdit = parseInt(e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index'));
                        const entry = allSalesEntries[indexToEdit];
                        
                        editingIndex = indexToEdit;
                        
                        // Populate the form with the entry's data
                        dateInput.value = entry.date;
                        storeSelect.value = entry.storeName;
                        document.getElementById('mobileNumber').value = entry.mobileNumber;
                        document.getElementById('invoiceNumber').value = entry.invoiceNumber;
                        gadgetSelect.value = entry.gadgetType;
                        document.getElementById('modelName').value = entry.modelName;
                        quantityInput.value = entry.quantity;
                        sellingPriceInput.value = entry.sellingPrice;
                        totalRevenueInput.value = entry.totalRevenue;
                        document.getElementById('due').value = entry.due;
                        
                        // Change button text and visibility
                        submitBtn.textContent = 'Update Entry';
                        cancelEditBtn.classList.remove('hidden');
                        
                        // Scroll to the top of the form
                        form.scrollIntoView({ behavior: 'smooth' });
                    });
                });
                
                document.querySelectorAll('.download-jpeg-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToDownload = parseInt(e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index'));
                        const entry = allSalesEntries[indexToDownload];
                        const filename = `receipt-${entry.invoiceNumber || entry.date}.jpeg`;
                        downloadAsJpeg(entry, filename);
                    });
                });
            };

            const clearForm = () => {
                const dateVal = dateInput.value;
                const storeVal = storeSelect.value;
                const mobileVal = mobileNumberInput.value;

                form.reset();
                dateInput.value = dateVal;

                if (keepShopInfoCheckbox.checked) {
                    storeSelect.value = storeVal;
                    mobileNumberInput.value = mobileVal;
                } else {
                    storeSelect.value = ""; // Reset to default "Select a store"
                    mobileNumberInput.value = "";
                }
                
                calculateTotalRevenue();
                
                // If in edit mode, revert to add mode
                if (editingIndex !== -1) {
                    editingIndex = -1;
                    submitBtn.textContent = 'Submit';
                    cancelEditBtn.classList.add('hidden');
                }
            };
            
            clearFormBtn.addEventListener('click', clearForm);
            cancelEditBtn.addEventListener('click', clearForm);

            const viewDues = () => {
                const dueEntries = allSalesEntries.filter(entry => parseFloat(entry.due) > 0);
                renderData(dueEntries);
            };

            viewDuesBtn.addEventListener('click', viewDues);

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                if (query === '') {
                    renderData(allSalesEntries);
                } else {
                    const filteredData = allSalesEntries.filter(entry =>
                        (entry.mobileNumber && entry.mobileNumber.toLowerCase().includes(query)) ||
                        (entry.invoiceNumber && entry.invoiceNumber.toLowerCase().includes(query)) ||
                        (entry.storeName && entry.storeName.toLowerCase().includes(query)) ||
                        (entry.date && entry.date.toLowerCase().includes(query))
                    );
                    renderData(filteredData);
                }
            });

            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                renderData(allSalesEntries);
            });

            const exportToCsv = () => {
                if (allSalesEntries.length === 0) {
                    showNotification("There is no data to export!", 'error');
                    return;
                }
                
                const headers = ["Date", "StoreName", "MobileNumber", "InvoiceNumber", "GadgetType", "ModelName", "Quantity", "SellingPrice", "TotalRevenue", "Due"];
                const keys = ["date", "storeName", "mobileNumber", "invoiceNumber", "gadgetType", "modelName", "quantity", "sellingPrice", "totalRevenue", "due"];
                
                const csvRows = [];
                csvRows.push(headers.join(','));

                for (const row of allSalesEntries) {
                    const values = keys.map(key => {
                        const value = row[key] !== undefined ? row[key] : '';
                        const escaped = ('' + value).replace(/"/g, '""');
                        return `"${escaped}"`;
                    });
                    csvRows.push(values.join(','));
                }

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'nrt_sales_data.csv';
                link.click();
            };
            
            exportBtn.addEventListener('click', exportToCsv);

            const validateForm = () => {
                let isValid = true;
                const requiredInputs = form.querySelectorAll('[required]');
                const mobileNumberInput = document.getElementById('mobileNumber');
                const mobileNumberError = document.getElementById('mobile-error');

                requiredInputs.forEach(input => {
                    if (input.value.trim() === '' || (input.tagName === 'SELECT' && input.value === '')) {
                        input.classList.add('invalid-field');
                        isValid = false;
                    } else {
                        input.classList.remove('invalid-field');
                    }
                });

                const mobileNumberValue = mobileNumberInput.value.trim();
                if (mobileNumberValue.length !== 11 || !/^\d{11}$/.test(mobileNumberValue)) {
                    mobileNumberInput.classList.add('invalid-field');
                    mobileNumberError.classList.remove('hidden');
                    isValid = false;
                } else {
                    mobileNumberInput.classList.remove('invalid-field');
                    mobileNumberError.classList.add('hidden');
                }

                return isValid;
            };

            const sendDataToGoogleSheet = async (data) => {
                try {
                    await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    return true;
                } catch (error) {
                    console.error('Error sending data to Google Sheet:', error);
                    return false;
                }
            };
            
            const syncOfflineData = async () => {
                if (navigator.onLine && offlineQueue.length > 0) {
                    showNotification(`Internet connection restored. Syncing ${offlineQueue.length} offline entries...`, 'success');
                    
                    const successfullySynced = [];
                    for (const entry of offlineQueue) {
                        const success = await sendDataToGoogleSheet(entry);
                        if (success) {
                            successfullySynced.push(entry);
                        }
                    }
                    
                    offlineQueue = offlineQueue.filter(entry => !successfullySynced.includes(entry));
                    saveDataToLocalStorage(OFFLINE_QUEUE_KEY, offlineQueue);

                    if (successfullySynced.length > 0) {
                        showNotification(`Synced ${successfullySynced.length} entries to Google Sheet!`, 'success');
                    }
                }
            };

            form.addEventListener('submit', (event) => {
                event.preventDefault();

                if (!validateForm()) {
                    showNotification('Please fill out all the required fields correctly.', 'error');
                    return;
                }
                
                const formData = new FormData(form);
                const newEntry = {};
                formData.forEach((value, key) => {
                    newEntry[key] = value;
                });
                
                newEntry.totalRevenue = totalRevenueInput.value;
                newEntry.due = newEntry.due || 0; // Ensure due is 0 if not provided
                
                // If we are editing, update the existing entry
                if (editingIndex !== -1) {
                    allSalesEntries[editingIndex] = newEntry;
                    showNotification('Entry updated successfully!');
                    editingIndex = -1; // Reset edit mode
                    submitBtn.textContent = 'Update Entry';
                    cancelEditBtn.classList.add('hidden');
                } else {
                    // Otherwise, add a new entry
                    allSalesEntries.push(newEntry);
                    showNotification('New entry added!');
                }

                saveDataToLocalStorage(SALES_KEY, allSalesEntries);

                if (navigator.onLine) {
                    sendDataToGoogleSheet(newEntry)
                        .then(success => {
                            if (success) {
                                showNotification('Data successfully sent to Google Sheet!', 'success');
                            } else {
                                offlineQueue.push(newEntry);
                                saveDataToLocalStorage(OFFLINE_QUEUE_KEY, offlineQueue);
                                showNotification('Failed to send data. Entry saved to offline queue.', 'error');
                            }
                        });
                } else {
                    offlineQueue.push(newEntry);
                    saveDataToLocalStorage(OFFLINE_QUEUE_KEY, offlineQueue);
                    showNotification('You are offline. Entry saved locally. Sync will happen automatically when online.', 'error');
                }
                
                // Keep date
                const lastDate = dateInput.value;
                
                // Keep store name and mobile if checkbox is checked
                const shouldKeepShopInfo = keepShopInfoCheckbox.checked;
                const lastStore = storeSelect.value;
                const lastMobileNumber = mobileNumberInput.value;

                form.reset();
                dateInput.value = lastDate;

                if (shouldKeepShopInfo) {
                    storeSelect.value = lastStore;
                    mobileNumberInput.value = lastMobileNumber;
                } else {
                    storeSelect.value = ""; // Reset to default "Select a store"
                }

                calculateTotalRevenue();

                renderData(allSalesEntries);
                refreshDashboardMetrics();
                if (dashboardView.classList.contains('hidden') === false) {
                    renderCharts();
                }
            });

            window.addEventListener('online', () => {
                syncOfflineData();
            });

            // NEW: Dashboard and Charting Functions

            // Helper function to get theme-appropriate colors
            const getChartColors = () => {
                const isDarkMode = document.documentElement.classList.contains('dark');
                return {
                    textColor: isDarkMode ? '#f3f4f6' : '#1f2937',
                    gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                    chartBg: isDarkMode ? '#1f2937' : '#ffffff',
                    colors: [
                        '#3d74b6', '#fbf5de', '#eac8a6', '#dc3c22', '#6366f1', '#60a5fa', '#34d399', '#fcd34d', '#f87171'
                    ]
                };
            };
            
            // Function to calculate linear regression for trendline
            const getLinearRegression = (x, y) => {
                let n = x.length;
                let sum_x = 0, sum_y = 0, sum_xy = 0, sum_x2 = 0;
                for (let i = 0; i < n; i++) {
                    sum_x += x[i];
                    sum_y += y[i];
                    sum_xy += x[i] * y[i];
                    sum_x2 += x[i] * x[i];
                }
                
                let a = (n * sum_xy - sum_x * sum_y) / (n * sum_x2 - sum_x * sum_x);
                let b = (sum_y / n) - a * (sum_x / n);
                
                return { a, b }; // a = slope, b = y-intercept
            };

            // Prepare data for the revenue chart with trendline
            const prepareRevenueData = () => {
                const groupedData = allSalesEntries.reduce((acc, entry) => {
                    const date = entry.date;
                    const revenue = parseFloat(entry.totalRevenue) || 0;
                    acc[date] = (acc[date] || 0) + revenue;
                    return acc;
                }, {});

                const sortedDates = Object.keys(groupedData).sort();
                const revenues = sortedDates.map(date => groupedData[date]);
                
                // Calculate trendline data
                const dateIndices = sortedDates.map((d, i) => i);
                const { a, b } = getLinearRegression(dateIndices, revenues);
                const trendlineData = sortedDates.map((d, i) => a * i + b);

                return { labels: sortedDates, data: revenues, trendlineData: trendlineData };
            };

            // Prepare data for the top gadgets chart
            const prepareGadgetSalesData = () => {
                const groupedData = allSalesEntries.reduce((acc, entry) => {
                    const gadget = entry.gadgetType;
                    acc[gadget] = (acc[gadget] || 0) + 1;
                    return acc;
                }, {});
                
                // Sort by sales count and get top 5
                const sortedGadgets = Object.entries(groupedData).sort(([, a], [, b]) => b - a);
                const topGadgets = sortedGadgets.slice(0, 5);

                return { labels: topGadgets.map(g => g[0]), data: topGadgets.map(g => g[1]) };
            };

            // Prepare data for the store sales chart
            const prepareStoreSalesData = () => {
                const groupedData = allSalesEntries.reduce((acc, entry) => {
                    const store = entry.storeName;
                    acc[store] = (acc[store] || 0) + 1;
                    return acc;
                }, {});

                return { labels: Object.keys(groupedData), data: Object.values(groupedData) };
            };
            
            // Function to update the dashboard metrics
            const refreshDashboardMetrics = () => {
                const totalSales = allSalesEntries.reduce((sum, entry) => sum + (parseFloat(entry.totalRevenue) || 0), 0);
                const totalDue = allSalesEntries.reduce((sum, entry) => sum + (parseFloat(entry.due) || 0), 0);
                const uniqueStores = new Set(allSalesEntries.map(entry => entry.storeName)).size;
                
                totalSalesEl.textContent = `BDT ${totalSales.toFixed(2)}`;
                totalDueEl.textContent = `BDT ${totalDue.toFixed(2)}`;
                totalShopsEl.textContent = uniqueStores;
            };

            // Function to render all charts
            const renderCharts = () => {
                const colors = getChartColors();
                
                // Destroy existing charts to prevent memory leaks and redraw issues
                if (revenueChart) revenueChart.destroy();
                if (gadgetSalesChart) gadgetSalesChart.destroy();
                if (storeSalesChart) storeSalesChart.destroy();

                const revenueData = prepareRevenueData();
                const gadgetData = prepareGadgetSalesData();
                const storeData = prepareStoreSalesData();

                // Revenue by Date Chart
                const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: revenueData.labels,
                        datasets: [
                            {
                                label: 'Total Revenue (BDT)',
                                data: revenueData.data,
                                borderColor: colors.colors[0],
                                backgroundColor: 'rgba(61, 116, 182, 0.2)',
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: colors.colors[0]
                            },
                            {
                                label: 'Trend Line',
                                data: revenueData.trendlineData,
                                borderColor: 'rgba(255, 99, 132, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                tension: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { labels: { color: colors.textColor } } },
                        scales: {
                            x: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            },
                            y: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            }
                        }
                    }
                });

                // Top Gadgets Chart (Doughnut)
                const gadgetCtx = document.getElementById('gadget-sales-chart').getContext('2d');
                gadgetSalesChart = new Chart(gadgetCtx, {
                    type: 'doughnut',
                    data: {
                        labels: gadgetData.labels,
                        datasets: [{
                            data: gadgetData.data,
                            backgroundColor: colors.colors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'right', labels: { color: colors.textColor } } }
                    }
                });

                // Sales by Store Chart (Bar)
                const storeCtx = document.getElementById('store-sales-chart').getContext('2d');
                storeSalesChart = new Chart(storeCtx, {
                    type: 'bar',
                    data: {
                        labels: storeData.labels,
                        datasets: [{
                            label: 'Number of Sales',
                            data: storeData.data,
                            backgroundColor: colors.colors,
                            borderColor: colors.colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            },
                            y: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            }
                        }
                    }
                });
            };

            // Toggle between form view and dashboard view
            toggleViewBtn.addEventListener('click', () => {
                if (formView.classList.contains('hidden')) {
                    formView.classList.remove('hidden');
                    dashboardView.classList.add('hidden');
                    toggleViewBtn.textContent = 'Switch to Dashboard';
                } else {
                    formView.classList.add('hidden');
                    dashboardView.classList.remove('hidden');
                    toggleViewBtn.textContent = 'Switch to Form';
                    renderCharts(); // Render charts when the dashboard is visible
                }
            });

            // --- Initialization ---
            const initializeApp = () => {
                allSalesEntries = loadDataFromLocalStorage(SALES_KEY, []);
                allStoreNames = loadDataFromLocalStorage(STORES_KEY, ['Hasan Tel', 'Classic Mobile', 'Big Rock', 'Shahenshah Gadgets', 'Students Gadgets', 'Phone Store', 'Telephonic', 'Rakib Telecom', 'i-Club', 'Navigation Center', 'Talha Telecom', 'Kajol Electronics', 'Talukdar Telecom', 'Company Store', 'Talukdar Telecom 2', 'Samart Sec & Tech', 'Bismillah Telecom', 'Sajol Telecom']);
                allGadgetTypes = loadDataFromLocalStorage(GADGETS_KEY, ['Phone Charger', 'Ear Buds', 'USB Cable', 'Ear Phone']);
                offlineQueue = loadDataFromLocalStorage(OFFLINE_QUEUE_KEY, []);
                loadDropdowns();
                calculateTotalRevenue();
                renderData(allSalesEntries);
                refreshDashboardMetrics();
                syncOfflineData();
            };

            initializeApp();
        });
    </script>
</body>
</html>
