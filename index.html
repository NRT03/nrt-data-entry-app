<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.R.T.</title>
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(
                    registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    },
                    err => {
                        console.log('Service Worker registration failed:', err);
                    }
                );
            });
        }
    </script>
    <style>
        /*!
         * Tailwindcss v3.4.4 | MIT License | https://tailwindcss.com
         */
        @tailwind base;
        @tailwind components;
        @tailwind utilities;
        
        .manage-toggle-btn {
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .manage-toggle-btn:hover {
            transform: scale(1.1);
        }
        .editable-item {
            cursor: pointer;
            outline: none;
            border-bottom: 1px dashed transparent;
        }
        .editable-item:focus {
            border-bottom: 1px dashed #3d74b6;
        }
        /* Custom modal for alerts */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            text-align: center;
        }
        .invalid-field {
            border-color: #ef4444 !important; /* Red border for invalid fields */
        }
        /* Custom notification style */
        .notification-container {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .notification {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            animation: fadeInOut 4s forwards;
        }
        .notification.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .notification.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        /* New style for the signature box */
        .signature-box {
            border: 1px solid #000;
            width: 150px;
            height: 60px;
            position: relative;
            margin-top: 1rem;
        }
        .signature-box::before {
            content: 'Signature';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #4b5563;
        }
        
        /* New receipt styles */
        .receipt-container {
            width: 350px;
            background-color: white;
            padding: 1rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #000;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .receipt-header h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .receipt-header p {
            font-size: 0.875rem;
        }
        .receipt-details p {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        .receipt-details strong {
            font-weight: 600;
        }
        .receipt-total {
            border-top: 2px dashed #000;
            margin-top: 1rem;
            padding-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.125rem;
            font-weight: bold;
        }
        .receipt-signature-box {
            border-top: 1px solid #000;
            text-align: center;
            margin-top: 2rem;
            padding-top: 0.5rem;
        }
        .receipt-signature-box p {
            font-size: 0.75rem;
            color: #4b5563;
        }

        /* Complete Tailwind CSS file from cdn.jsdelivr.net */
        /*
        ! tailwindcss v3.4.4 | MIT License | https://tailwindcss.com
        */
        
        /*
        @layer base {
          :root {
            --tw-color-50: #fbf5de;
            --tw-color-100: #f8f1d5;
            --tw-color-200: #f2e4b4;
            --tw-color-300: #eac8a6;
            --tw-color-400: #e2a97d;
            --tw-color-500: #d68b55;
            --tw-color-600: #c16e3c;
            --tw-color-700: #a5542f;
            --tw-color-800: #883d25;
            --tw-color-900: #6d2f1f;
            --tw-color-950: #44170d;
          }
        }
        */

        *, ::before, ::after {
            box-sizing: border-box;
            border-width: 0;
            border-style: solid;
            border-color: #e5e7eb;
        }
        ::before, ::after {
            --tw-content: '';
        }
        html {
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -moz-tab-size: 4;
            -o-tab-size: 4;
            tab-size: 4;
            font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            font-feature-settings: normal;
            font-variation-settings: normal;
        }
        body {
            margin: 0;
            line-height: inherit;
        }
        hr {
            height: 0;
            color: inherit;
            border-top-width: 1px;
        }
        abbr:where([title]) {
            -webkit-text-decoration: underline;
            text-decoration: underline;
            -webkit-text-decoration-color: inherit;
            text-decoration-color: inherit;
            -webkit-text-decoration-style: dotted;
            text-decoration-style: dotted;
        }
        h1, h2, h3, h4, h5, h6 {
            font-size: inherit;
            font-weight: inherit;
        }
        a {
            color: inherit;
            text-decoration: inherit;
        }
        b, strong {
            font-weight: bolder;
        }
        code, kbd, samp, pre {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-feature-settings: normal;
            font-variation-settings: normal;
            font-size: 1em;
        }
        small {
            font-size: 80%;
        }
        sub, sup {
            font-size: 75%;
            line-height: 0;
            position: relative;
            vertical-align: baseline;
        }
        sub {
            bottom: -0.25em;
        }
        sup {
            top: -0.5em;
        }
        table {
            -webkit-text-indent: 0;
            text-indent: 0;
            border-collapse: collapse;
            border-color: inherit;
        }
        button, input, optgroup, select, textarea {
            font-family: inherit;
            font-feature-settings: inherit;
            font-variation-settings: inherit;
            font-size: 100%;
            font-weight: inherit;
            line-height: inherit;
            color: inherit;
            margin: 0;
            padding: 0;
        }
        button, select {
            -webkit-text-transform: none;
            text-transform: none;
        }
        button, [type='button'], [type='reset'], [type='submit'] {
            -webkit-appearance: button;
            background-color: transparent;
            background-image: none;
        }
        :-moz-focusring {
            outline: 1px dotted ButtonText;
        }
        :-moz-ui-invalid {
            border-color: #ef4444;
        }
        ::-webkit-file-upload-button {
            -webkit-appearance: button;
            font: inherit;
        }
        [type='search'] {
            -webkit-appearance: textfield;
            outline-offset: -2px;
        }
        ::-webkit-search-decoration {
            -webkit-appearance: none;
        }
        ::-webkit-inner-spin-button, ::-webkit-outer-spin-button {
            height: auto;
        }
        
        textarea {
            resize: vertical;
        }
        input::placeholder, textarea::placeholder {
            opacity: 1;
            color: #9ca3af;
        }
        [role="button"], button {
            cursor: pointer;
        }
        :disabled {
            cursor: default;
        }
        img, svg, video, canvas, audio, iframe, embed, object {
            display: block;
            vertical-align: middle;
        }
        img, video {
            max-width: 100%;
            height: auto;
        }
        [hidden] {
            display: none;
        }

        .space-x-2 > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 0;
            margin-right: calc(0.5rem * var(--tw-space-x-reverse));
            margin-left: calc(0.5rem * calc(1 - var(--tw-space-x-reverse)));
        }
        .space-x-4 > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 0;
            margin-right: calc(1rem * var(--tw-space-x-reverse));
            margin-left: calc(1rem * calc(1 - var(--tw-space-x-reverse)));
        }
        .space-x-6 > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 0;
            margin-right: calc(1.5rem * var(--tw-space-x-reverse));
            margin-left: calc(1.5rem * calc(1 - var(--tw-space-x-reverse)));
        }
        .space-y-2 > :not([hidden]) ~ :not([hidden]) {
            --tw-space-y-reverse: 0;
            margin-top: calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));
            margin-bottom: calc(0.5rem * var(--tw-space-y-reverse));
        }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) {
            --tw-space-y-reverse: 0;
            margin-top: calc(1rem * calc(1 - var(--tw-space-y-reverse)));
            margin-bottom: calc(1rem * var(--tw-space-y-reverse));
        }
        .space-y-6 > :not([hidden]) ~ :not([hidden]) {
            --tw-space-y-reverse: 0;
            margin-top: calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));
            margin-bottom: calc(1.5rem * var(--tw-space-y-reverse));
        }
        .block {
            display: block;
        }
        .flex {
            display: flex;
        }
        .hidden {
            display: none;
        }
        .h-4 {
            height: 1rem;
        }
        .h-5 {
            height: 1.25rem;
        }
        .w-4 {
            width: 1rem;
        }
        .w-5 {
            width: 1.25rem;
        }
        .w-full {
            width: 100%;
        }
        .flex-1 {
            flex: 1 1 0%;
        }
        .flex-col {
            flex-direction: column;
        }
        .cursor-pointer {
            cursor: pointer;
        }
        .cursor-not-allowed {
            cursor: not-allowed;
        }
        .transform {
            transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
        }
        .transition {
            transition-property: color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-backdrop-filter;
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
            transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-backdrop-filter;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        .duration-150 {
            transition-duration: 150ms;
        }
        .duration-200 {
            transition-duration: 200ms;
        }
        .scale-105:hover {
            --tw-scale-x: 1.05;
            --tw-scale-y: 1.05;
        }
        .ease-in-out {
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        .p-3 {
            padding: 0.75rem;
        }
        .p-4 {
            padding: 1rem;
        }
        .p-6 {
            padding: 1.5rem;
        }
        .p-8 {
            padding: 2rem;
        }
        .px-2 {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .py-1 {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .py-3 {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .text-center {
            text-align: center;
        }
        .text-left {
            text-align: left;
        }
        .text-right {
            text-align: right;
        }
        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        .text-lg {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }
        .text-xl {
            font-size: 1.25rem;
            line-height: 1.75rem;
        }
        .text-3xl {
            font-size: 1.875rem;
            line-height: 2.25rem;
        }
        .text-gray-900 {
            color: #111827;
        }
        .bg-gray-100 {
            background-color: #f3f4f6;
        }
        .border-gray-200 {
            border-color: #e5e7eb;
        }
        .rounded-md {
            border-radius: 0.375rem;
        }
        .shadow-md {
            --tw-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --tw-shadow-colored: 0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);
            box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
        }
        @media (min-width: 640px) {
            .sm\:text-left {
                text-align: left;
            }
            .sm\:flex-row {
                flex-direction: row;
            }
        }
        @media (min-width: 768px) {
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        .md\:col-span-2 {
            grid-column: span 2 / span 2;
        }
        .md\:text-left {
            text-align: left;
        }
        .md\:text-lg {
            font-size: 1.125rem;
        }
        .md\:flex-row {
            flex-direction: row;
        }
        .md\:space-x-4 > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 0;
            margin-right: calc(1rem * var(--tw-space-x-reverse));
            margin-left: calc(1rem * calc(1 - var(--tw-space-x-reverse)));
        }
        .md\:space-y-0 > :not([hidden]) ~ :not([hidden]) {
            --tw-space-y-reverse: 0;
            margin-top: calc(0px * calc(1 - var(--tw-space-y-reverse)));
            margin-bottom: calc(0px * var(--tw-space-y-reverse));
        }

        /*
        ! Chart.js v3.7.0 | MIT License | https://www.chartjs.org
        */
        /*!
         * Chart.js
         * http://chartjs.org/
         *
         * Copyright 2021 Chart.js Contributors
         * Released under the MIT license
         * https://github.com/chartjs/Chart.js/blob/master/LICENSE.md
         */
        
        @keyframes chartjs-tooltip-anim {
          0% {
            opacity: 0;
            transform: translateY(-10px);
          }
          50% {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        canvas {
          -moz-user-select: none;
          -webkit-user-select: none;
          -ms-user-select: none;
          user-select: none;
        }
        
        .chartjs-render-monitor {
          -webkit-animation: chartjs-tooltip-anim 0.5s;
          animation: chartjs-tooltip-anim 0.5s;
        }

        .chartjs-tooltip {
          position: absolute;
          background-color: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 8px;
          border-radius: 4px;
          pointer-events: none;
          z-index: 10;
          font-size: 12px;
          line-height: 1.4;
          opacity: 0;
          transition: all 0.2s ease;
        }
        
        .chartjs-tooltip-header {
          padding-bottom: 4px;
          margin-bottom: 4px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chartjs-tooltip-body {
          margin: 0;
          padding: 0;
        }
        
        .chartjs-tooltip-label {
          display: block;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Keys for Local Storage
            const SALES_KEY = 'chinoMartSales';
            const STORES_KEY = 'chinoMartStores';
            const GADGETS_KEY = 'chinoMartGadgets';
            const OFFLINE_QUEUE_KEY = 'chinoMartOfflineQueue';
            const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwOyZ_ehxURDo1giZ9eFI1fMZnxkhzUOTFIJkGAze2YDU4xDoRACSaTW1uNdsFNHHBH/exec';
        
            // Helper function to save data to Local Storage
            const saveDataToLocalStorage = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving to Local Storage', e);
                    showNotification('Could not save data to your device. Local Storage might be full or disabled.', 'error');
                }
            };
        
            // Helper function to load data from Local Storage
            const loadDataFromLocalStorage = (key, defaultData) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultData;
                } catch (e) {
                    console.error('Error loading from Local Storage', e);
                    return defaultData;
                }
            };
        
            // State for the application, loaded from Local Storage
            let allSalesEntries = loadDataFromLocalStorage(SALES_KEY, []);
            let allStoreNames = loadDataFromLocalStorage(STORES_KEY, ['Hasan Tel', 'Classic Mobile', 'Big Rock', 'Shahenshah Gadgets', 'Students Gadgets', 'Phone Store', 'Telephonic', 'Rakib Telecom', 'i-Club', 'Navigation Center', 'Talha Telecom', 'Kajol Electronics', 'Talukdar Telecom', 'Company Store', 'Talukdar Telecom 2', 'Samart Sec & Tech', 'Bismillah Telecom', 'Sajol Telecom']);
            let allGadgetTypes = loadDataFromLocalStorage(GADGETS_KEY, ['Phone Charger', 'Ear Buds', 'USB Cable', 'Ear Phone']);
            let offlineQueue = loadDataFromLocalStorage(OFFLINE_QUEUE_KEY, []);
            let editingIndex = -1; // -1 means no entry is being edited
        
            // DOM elements
            const form = document.getElementById('sales-form');
            const entriesList = document.getElementById('entries-list');
            const quantityInput = document.getElementById('quantity');
            const sellingPriceInput = document.getElementById('sellingPrice');
            const totalRevenueInput = document.getElementById('totalRevenue');
            const exportBtn = document.getElementById('export-btn');
            const manageStoresToggleBtn = document.getElementById('manage-stores-toggle');
            const manageStoresContainer = document.getElementById('manage-stores-container');
            const newStoreInput = document.getElementById('new-store-input');
            const addStoreBtn = document.getElementById('add-store-btn');
            const storeList = document.getElementById('store-list');
            const manageGadgetsToggleBtn = document.getElementById('manage-gadgets-toggle');
            const manageGadgetsContainer = document.getElementById('manage-gadgets-container');
            const newGadgetInput = document.getElementById('new-gadget-input');
            const addGadgetBtn = document.getElementById('add-gadget-btn');
            const storeSelect = document.getElementById('storeName');
            const gadgetSelect = document.getElementById('gadgetType');
            const gadgetList = document.getElementById('gadget-list');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const customModal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const notificationContainer = document.querySelector('.notification-container');
            const toggleViewBtn = document.getElementById('toggle-view-btn');
            const formView = document.getElementById('form-view');
            const dashboardView = document.getElementById('dashboard-view');
            const submitBtn = document.getElementById('submit-btn');
            const clearFormBtn = document.getElementById('clear-form-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const viewDuesBtn = document.getElementById('view-dues-btn');
            const dateInput = document.getElementById('date');
            const mobileNumberInput = document.getElementById('mobileNumber');
            const keepShopInfoCheckbox = document.getElementById('keep-shop-info');
        
            // Dashboard Metrics
            const totalSalesEl = document.getElementById('total-sales');
            const totalDueEl = document.getElementById('total-due');
            const totalShopsEl = document.getElementById('total-shops');
        
            // Chart.js chart instances
            let revenueChart, gadgetSalesChart, storeSalesChart;
        
            // Helper function for custom alerts
            const customAlert = (message, onConfirmCallback = () => {}) => {
                modalTitle.textContent = 'Alert';
                modalText.textContent = message;
                customModal.classList.remove('hidden');
                modalConfirmBtn.onclick = () => {
                    customModal.classList.add('hidden');
                    onConfirmCallback();
                };
            };
            
            // Show a temporary notification
            const showNotification = (message, type = 'success') => {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notificationContainer.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 4000); // Notification disappears after 4 seconds
            };
        
            // Load theme from system preference
            const loadTheme = () => {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            };
            
            loadTheme();
            
            // Load and populate dropdowns from the local data
            const loadDropdowns = () => {
                storeSelect.innerHTML = '<option value="" disabled selected>Select a store</option>';
                allStoreNames.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    storeSelect.appendChild(option);
                });
        
                gadgetSelect.innerHTML = '<option value="" disabled selected>Select a gadget type</option>';
                allGadgetTypes.sort().forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    gadgetSelect.appendChild(option);
                });
            };
        
            // Render the management lists with edit and delete buttons
            const renderManagementList = (inputElement, listElement, items, type) => {
                const query = inputElement.value.toLowerCase();
                listElement.innerHTML = '';
                
                const filteredItems = items.filter(item => item.toLowerCase().includes(query));
        
                if (filteredItems.length === 0 && query !== '') {
                    listElement.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">No results found for "${query}".</p>`;
                } else if (filteredItems.length > 0) {
                    filteredItems.forEach(item => {
                        const listItem = document.createElement('div');
                        listItem.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                        listItem.innerHTML = `
                            <span contenteditable="true" class="editable-item text-gray-900 dark:text-gray-50 px-2 py-1" data-old-value="${item}">${item}</span>
                            <div>
                                <button type="button" class="delete-item-btn text-[#dc3c22] hover:text-[#b0301a] ml-2" data-item="${item}" data-type="${type}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 0 0 1-2-2V6"></path>
                                        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </div>
                        `;
                        listElement.appendChild(listItem);
                    });
                }
                
                listElement.querySelectorAll('.editable-item').forEach(itemSpan => {
                    itemSpan.addEventListener('blur', (e) => {
                        const oldItem = e.target.getAttribute('data-old-value');
                        const newItem = e.target.textContent.trim();
                        const isStore = type === 'store';
                        
                        if (newItem === '' || newItem === oldItem) {
                            e.target.textContent = oldItem;
                            return;
                        }
                        
                        const itemsArray = isStore ? allStoreNames : allGadgetTypes;
                        if (itemsArray.map(i => i.toLowerCase()).includes(newItem.toLowerCase())) {
                            customAlert(`"${newItem}" already exists. Please use a different name.`);
                            e.target.textContent = oldItem;
                            return;
                        }
                        
                        const index = itemsArray.indexOf(oldItem);
                        if (index > -1) {
                            itemsArray[index] = newItem;
                        }
                        
                        e.target.setAttribute('data-old-value', newItem);
                        
                        if (isStore) {
                            saveDataToLocalStorage(STORES_KEY, allStoreNames);
                        } else {
                            saveDataToLocalStorage(GADGETS_KEY, allGadgetTypes);
                        }
                        
                        loadDropdowns();
                        showNotification(`${oldItem} was updated to ${newItem}!`);
                    });
                });
                
                listElement.querySelectorAll('.delete-item-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const itemToDelete = e.target.getAttribute('data-item') || e.target.closest('button').getAttribute('data-item');
                        const isStore = e.target.getAttribute('data-type') === 'store' || e.target.closest('button').getAttribute('data-type') === 'store';
                        
                        customAlert(`Are you sure you want to delete "${itemToDelete}"?`, () => {
                            if (isStore) {
                                allStoreNames = allStoreNames.filter(name => name !== itemToDelete);
                                saveDataToLocalStorage(STORES_KEY, allStoreNames);
                                loadDropdowns();
                                renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                            } else {
                                allGadgetTypes = allGadgetTypes.filter(name => name !== itemToDelete);
                                saveDataToLocalStorage(GADGETS_KEY, allGadgetTypes);
                                loadDropdowns();
                                renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                            }
                            showNotification(`${itemToDelete} deleted successfully!`);
                        });
                    });
                });
            };
        
            const updateAddButtonState = (inputElement, buttonElement, items) => {
                const inputValue = inputElement.value.trim();
                const itemExists = items.map(item => item.toLowerCase()).includes(inputValue.toLowerCase());
                
                if (inputValue === '' || itemExists) {
                    buttonElement.disabled = true;
                } else {
                    buttonElement.disabled = false;
                }
            };
            
            addStoreBtn.addEventListener('click', () => {
                const newStore = newStoreInput.value.trim();
                if (newStore && !allStoreNames.map(name => name.toLowerCase()).includes(newStore.toLowerCase())) {
                    allStoreNames.push(newStore);
                    newStoreInput.value = '';
                    saveDataToLocalStorage(STORES_KEY, allStoreNames);
                    loadDropdowns();
                    renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                    updateAddButtonState(newStoreInput, addStoreBtn, allStoreNames);
                    showNotification('New store added!');
                } else {
                    customAlert(`"${newStore}" already exists or is invalid.`);
                }
            });
        
            addGadgetBtn.addEventListener('click', () => {
                const newGadget = newGadgetInput.value.trim();
                if (newGadget && !allGadgetTypes.map(type => type.toLowerCase()).includes(newGadget.toLowerCase())) {
                    allGadgetTypes.push(newGadget);
                    newGadgetInput.value = '';
                    saveDataToLocalStorage(GADGETS_KEY, allGadgetTypes);
                    loadDropdowns();
                    renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                    updateAddButtonState(newGadgetInput, addGadgetBtn, allGadgetTypes);
                    showNotification('New gadget type added!');
                } else {
                    customAlert(`"${newGadget}" already exists or is invalid.`);
                }
            });
        
            newStoreInput.addEventListener('input', () => {
                renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                updateAddButtonState(newStoreInput, addStoreBtn, allStoreNames);
            });
            newGadgetInput.addEventListener('input', () => {
                renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                updateAddButtonState(newGadgetInput, addGadgetBtn, allGadgetTypes);
            });
        
            manageStoresToggleBtn.addEventListener('click', () => {
                manageStoresContainer.classList.toggle('hidden');
                if (!manageStoresContainer.classList.contains('hidden')) {
                    renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                    updateAddButtonState(newStoreInput, addStoreBtn, allStoreNames);
                }
            });
            manageGadgetsToggleBtn.addEventListener('click', () => {
                manageGadgetsContainer.classList.toggle('hidden');
                if (!manageGadgetsContainer.classList.contains('hidden')) {
                    renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                    updateAddButtonState(newGadgetInput, addGadgetBtn, allGadgetTypes);
                }
            });
        
            const calculateTotalRevenue = () => {
                const quantity = parseFloat(quantityInput.value) || 0;
                const sellingPrice = parseFloat(sellingPriceInput.value) || 0;
                const totalRevenue = quantity * sellingPrice;
                totalRevenueInput.value = totalRevenue.toFixed(2);
            };
        
            quantityInput.addEventListener('input', calculateTotalRevenue);
            sellingPriceInput.addEventListener('input', calculateTotalRevenue);
            
            const downloadAsJpeg = (entry, filename) => {
                const receiptHtml = `
                    <div class="receipt-container">
                        <div class="receipt-header">
                            <h1>ChinoMart BD</h1>
                            <p>Money Receipt</p>
                        </div>
                        <div class="receipt-details">
                            <p><strong>Date:</strong> ${entry.date}</p>
                            <p><strong>Store:</strong> ${entry.storeName}</p>
                            <p><strong>Mobile:</strong> ${entry.mobileNumber}</p>
                            <p><strong>Invoice:</strong> ${entry.invoiceNumber}</p>
                            <p><strong>Gadget:</strong> ${entry.gadgetType} - ${entry.modelName}</p>
                            <p><strong>Quantity:</strong> ${entry.quantity}</p>
                            <p><strong>Price:</strong> BDT ${parseFloat(entry.sellingPrice).toFixed(2)}</p>
                        </div>
                        <div class="receipt-total">
                            <p><strong>Total:</strong> BDT ${parseFloat(entry.totalRevenue).toFixed(2)}</p>
                            <p><strong>Due:</strong> ${entry.due && parseFloat(entry.due) > 0 ? `<span class="text-[#dc3c22]">BDT ${parseFloat(entry.due).toFixed(2)}</span>` : 'Paid'}</p>
                        </div>
                        <div class="receipt-signature-box">
                            <p>Signature</p>
                        </div>
                    </div>
                `;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = receiptHtml;
                document.body.appendChild(tempDiv);
                
                const receiptElement = tempDiv.querySelector('.receipt-container');
        
                html2canvas(receiptElement, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    showNotification('Receipt downloaded as JPEG!');
                    
                    // Clean up the temporary element
                    tempDiv.remove();
                }).catch(error => {
                    console.error('Error generating JPEG:', error);
                    showNotification('Could not download the receipt. Please try again.', 'error');
                    
                    // Clean up in case of error as well
                    tempDiv.remove();
                });
            };
        
            const renderData = (data) => {
                entriesList.innerHTML = '';
                
                if (data.length === 0) {
                    entriesList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No matching entries found.</p>';
                    return;
                }
        
                data.forEach((entry, index) => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start';
                    entryDiv.innerHTML = `
                        <div>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Date:</strong> ${entry.date}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Store:</strong> ${entry.storeName}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Mobile:</strong> ${entry.mobileNumber}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Invoice:</strong> ${entry.invoiceNumber}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Gadget:</strong> ${entry.gadgetType} - ${entry.modelName}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Quantity:</strong> ${entry.quantity}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Price:</strong> BDT ${entry.sellingPrice}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Total:</strong> BDT ${entry.totalRevenue}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Due:</strong> ${entry.due && parseFloat(entry.due) > 0 ? `<span class="text-[#dc3c22] font-bold">BDT ${parseFloat(entry.due).toFixed(2)}</span>` : 'Paid'}</p>
                        </div>
                        <div class="flex space-x-2 mt-4 sm:mt-0">
                             <button type="button" class="download-jpeg-btn px-2 py-1 bg-[#3d74b6] hover:bg-[#2d5f99] rounded-md text-white text-xs font-semibold" data-index="${index}">
                                Download as JPEG
                            </button>
                             <button type="button" class="edit-btn px-2 py-1 bg-[#eac8a6] hover:bg-[#d6b797] rounded-md text-white text-xs font-semibold" data-index="${index}">
                                Edit
                            </button>
                            <button type="button" class="delete-btn px-2 py-1 bg-[#dc3c22] hover:bg-[#b0301a] rounded-md text-white text-xs font-semibold" data-index="${index}">
                                Delete
                            </button>
                        </div>
                    `;
                    entriesList.appendChild(entryDiv);
                });
        
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToDelete = parseInt(e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index'));
                        customAlert('Are you sure you want to delete this sales entry?', () => {
                            allSalesEntries.splice(indexToDelete, 1);
                            saveDataToLocalStorage(SALES_KEY, allSalesEntries);
                            renderData(allSalesEntries);
                            refreshDashboardMetrics();
                            showNotification('Entry deleted successfully!');
                            if (dashboardView.classList.contains('hidden') === false) {
                                renderCharts();
                            }
                        });
                    });
                });
                
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToEdit = parseInt(e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index'));
                        const entry = allSalesEntries[indexToEdit];
                        
                        editingIndex = indexToEdit;
                        
                        // Populate the form with the entry's data
                        dateInput.value = entry.date;
                        storeSelect.value = entry.storeName;
                        document.getElementById('mobileNumber').value = entry.mobileNumber;
                        document.getElementById('invoiceNumber').value = entry.invoiceNumber;
                        gadgetSelect.value = entry.gadgetType;
                        document.getElementById('modelName').value = entry.modelName;
                        quantityInput.value = entry.quantity;
                        sellingPriceInput.value = entry.sellingPrice;
                        totalRevenueInput.value = entry.totalRevenue;
                        document.getElementById('due').value = entry.due;
                        
                        // Change button text and visibility
                        submitBtn.textContent = 'Update Entry';
                        cancelEditBtn.classList.remove('hidden');
                        
                        // Scroll to the top of the form
                        form.scrollIntoView({ behavior: 'smooth' });
                    });
                });
                
                document.querySelectorAll('.download-jpeg-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToDownload = parseInt(e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index'));
                        const entry = allSalesEntries[indexToDownload];
                        const filename = `receipt-${entry.invoiceNumber || entry.date}.jpeg`;
                        downloadAsJpeg(entry, filename);
                    });
                });
            };
        
            const clearForm = () => {
                const dateVal = dateInput.value;
                const storeVal = storeSelect.value;
                const mobileVal = mobileNumberInput.value;
        
                form.reset();
                dateInput.value = dateVal;
        
                if (keepShopInfoCheckbox.checked) {
                    storeSelect.value = storeVal;
                    mobileNumberInput.value = mobileVal;
                } else {
                    storeSelect.value = ""; // Reset to default "Select a store"
                    mobileNumberInput.value = "";
                }
                
                calculateTotalRevenue();
                
                // If in edit mode, revert to add mode
                if (editingIndex !== -1) {
                    editingIndex = -1;
                    submitBtn.textContent = 'Submit';
                    cancelEditBtn.classList.add('hidden');
                }
            };
            
            clearFormBtn.addEventListener('click', clearForm);
            cancelEditBtn.addEventListener('click', clearForm);
        
            const viewDues = () => {
                const dueEntries = allSalesEntries.filter(entry => parseFloat(entry.due) > 0);
                renderData(dueEntries);
            };
        
            viewDuesBtn.addEventListener('click', viewDues);
        
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                if (query === '') {
                    renderData(allSalesEntries);
                } else {
                    const filteredData = allSalesEntries.filter(entry =>
                        (entry.mobileNumber && entry.mobileNumber.toLowerCase().includes(query)) ||
                        (entry.invoiceNumber && entry.invoiceNumber.toLowerCase().includes(query)) ||
                        (entry.storeName && entry.storeName.toLowerCase().includes(query)) ||
                        (entry.date && entry.date.toLowerCase().includes(query))
                    );
                    renderData(filteredData);
                }
            });
        
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                renderData(allSalesEntries);
            });
        
            const exportToCsv = () => {
                if (allSalesEntries.length === 0) {
                    showNotification("There is no data to export!", 'error');
                    return;
                }
                
                const headers = ["Date", "StoreName", "MobileNumber", "InvoiceNumber", "GadgetType", "ModelName", "Quantity", "SellingPrice", "TotalRevenue", "Due"];
                const keys = ["date", "storeName", "mobileNumber", "invoiceNumber", "gadgetType", "modelName", "quantity", "sellingPrice", "totalRevenue", "due"];
                
                const csvRows = [];
                csvRows.push(headers.join(','));
        
                for (const row of allSalesEntries) {
                    const values = keys.map(key => {
                        const value = row[key] !== undefined ? row[key] : '';
                        const escaped = ('' + value).replace(/"/g, '""');
                        return `"${escaped}"`;
                    });
                    csvRows.push(values.join(','));
                }
        
                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'nrt_sales_data.csv';
                link.click();
            };
            
            exportBtn.addEventListener('click', exportToCsv);
        
            const validateForm = () => {
                let isValid = true;
                const requiredInputs = form.querySelectorAll('[required]');
                const mobileNumberInput = document.getElementById('mobileNumber');
                const mobileNumberError = document.getElementById('mobile-error');
        
                requiredInputs.forEach(input => {
                    if (input.value.trim() === '' || (input.tagName === 'SELECT' && input.value === '')) {
                        input.classList.add('invalid-field');
                        isValid = false;
                    } else {
                        input.classList.remove('invalid-field');
                    }
                });
        
                const mobileNumberValue = mobileNumberInput.value.trim();
                if (mobileNumberValue.length !== 11 || !/^\d{11}$/.test(mobileNumberValue)) {
                    mobileNumberInput.classList.add('invalid-field');
                    mobileNumberError.classList.remove('hidden');
                    isValid = false;
                } else {
                    mobileNumberInput.classList.remove('invalid-field');
                    mobileNumberError.classList.add('hidden');
                }
        
                return isValid;
            };
        
            const sendDataToGoogleSheet = async (data) => {
                try {
                    await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    return true;
                } catch (error) {
                    console.error('Error sending data to Google Sheet:', error);
                    return false;
                }
            };
            
            const syncOfflineData = async () => {
                if (navigator.onLine && offlineQueue.length > 0) {
                    showNotification(`Internet connection restored. Syncing ${offlineQueue.length} offline entries...`, 'success');
                    
                    const successfullySynced = [];
                    for (const entry of offlineQueue) {
                        const success = await sendDataToGoogleSheet(entry);
                        if (success) {
                            successfullySynced.push(entry);
                        }
                    }
                    
                    offlineQueue = offlineQueue.filter(entry => !successfullySynced.includes(entry));
                    saveDataToLocalStorage(OFFLINE_QUEUE_KEY, offlineQueue);
        
                    if (successfullySynced.length > 0) {
                        showNotification(`Synced ${successfullySynced.length} entries to Google Sheet!`, 'success');
                    }
                }
            };
        
            form.addEventListener('submit', (event) => {
                event.preventDefault();
        
                if (!validateForm()) {
                    showNotification('Please fill out all the required fields correctly.', 'error');
                    return;
                }
                
                const formData = new FormData(form);
                const newEntry = {};
                formData.forEach((value, key) => {
                    newEntry[key] = value;
                });
                
                newEntry.totalRevenue = totalRevenueInput.value;
                newEntry.due = newEntry.due || 0; // Ensure due is 0 if not provided
                
                // If we are editing, update the existing entry
                if (editingIndex !== -1) {
                    allSalesEntries[editingIndex] = newEntry;
                    showNotification('Entry updated successfully!');
                    editingIndex = -1; // Reset edit mode
                    submitBtn.textContent = 'Update Entry';
                    cancelEditBtn.classList.add('hidden');
                } else {
                    // Otherwise, add a new entry
                    allSalesEntries.push(newEntry);
                    showNotification('New entry added!');
                }
        
                saveDataToLocalStorage(SALES_KEY, allSalesEntries);
        
                if (navigator.onLine) {
                    sendDataToGoogleSheet(newEntry)
                        .then(success => {
                            if (success) {
                                showNotification('Data successfully sent to Google Sheet!', 'success');
                            } else {
                                offlineQueue.push(newEntry);
                                saveDataToLocalStorage(OFFLINE_QUEUE_KEY, offlineQueue);
                                showNotification('Failed to send data. Entry saved to offline queue.', 'error');
                            }
                        });
                } else {
                    offlineQueue.push(newEntry);
                    saveDataToLocalStorage(OFFLINE_QUEUE_KEY, offlineQueue);
                    showNotification('You are offline. Entry saved locally. Sync will happen automatically when online.', 'error');
                }
                
                // Keep date
                const lastDate = dateInput.value;
                
                // Keep store name and mobile if checkbox is checked
                const shouldKeepShopInfo = keepShopInfoCheckbox.checked;
                const lastStore = storeSelect.value;
                const lastMobileNumber = mobileNumberInput.value;
        
                form.reset();
                dateInput.value = lastDate;
        
                if (shouldKeepShopInfo) {
                    storeSelect.value = lastStore;
                    mobileNumberInput.value = lastMobileNumber;
                } else {
                    storeSelect.value = ""; // Reset to default "Select a store"
                }
        
                calculateTotalRevenue();
        
                renderData(allSalesEntries);
                refreshDashboardMetrics();
                if (dashboardView.classList.contains('hidden') === false) {
                    renderCharts();
                }
            });
        
            window.addEventListener('online', () => {
                syncOfflineData();
            });
        
            // NEW: Dashboard and Charting Functions
        
            // Helper function to get theme-appropriate colors
            const getChartColors = () => {
                const isDarkMode = document.documentElement.classList.contains('dark');
                return {
                    textColor: isDarkMode ? '#f3f4f6' : '#1f2937',
                    gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                    chartBg: isDarkMode ? '#1f2937' : '#ffffff',
                    colors: [
                        '#3d74b6', '#fbf5de', '#eac8a6', '#dc3c22', '#6366f1', '#60a5fa', '#34d399', '#fcd34d', '#f87171'
                    ]
                };
            };
            
            // Function to calculate linear regression for trendline
            const getLinearRegression = (x, y) => {
                let n = x.length;
                let sum_x = 0, sum_y = 0, sum_xy = 0, sum_x2 = 0;
                for (let i = 0; i < n; i++) {
                    sum_x += x[i];
                    sum_y += y[i];
                    sum_xy += x[i] * y[i];
                    sum_x2 += x[i] * x[i];
                }
                
                let a = (n * sum_xy - sum_x * sum_y) / (n * sum_x2 - sum_x * sum_x);
                let b = (sum_y / n) - a * (sum_x / n);
                
                return { a, b }; // a = slope, b = y-intercept
            };
        
            // Prepare data for the revenue chart with trendline
            const prepareRevenueData = () => {
                const groupedData = allSalesEntries.reduce((acc, entry) => {
                    const date = entry.date;
                    const revenue = parseFloat(entry.totalRevenue) || 0;
                    acc[date] = (acc[date] || 0) + revenue;
                    return acc;
                }, {});
        
                const sortedDates = Object.keys(groupedData).sort();
                const revenues = sortedDates.map(date => groupedData[date]);
                
                // Calculate trendline data
                const dateIndices = sortedDates.map((d, i) => i);
                const { a, b } = getLinearRegression(dateIndices, revenues);
                const trendlineData = sortedDates.map((d, i) => a * i + b);
        
                return { labels: sortedDates, data: revenues, trendlineData: trendlineData };
            };
        
            // Prepare data for the top gadgets chart
            const prepareGadgetSalesData = () => {
                const groupedData = allSalesEntries.reduce((acc, entry) => {
                    const gadget = entry.gadgetType;
                    acc[gadget] = (acc[gadget] || 0) + 1;
                    return acc;
                }, {});
                
                // Sort by sales count and get top 5
                const sortedGadgets = Object.entries(groupedData).sort(([, a], [, b]) => b - a);
                const topGadgets = sortedGadgets.slice(0, 5);
        
                return { labels: topGadgets.map(g => g[0]), data: topGadgets.map(g => g[1]) };
            };
        
            // Prepare data for the store sales chart
            const prepareStoreSalesData = () => {
                const groupedData = allSalesEntries.reduce((acc, entry) => {
                    const store = entry.storeName;
                    acc[store] = (acc[store] || 0) + 1;
                    return acc;
                }, {});
        
                return { labels: Object.keys(groupedData), data: Object.values(groupedData) };
            };
            
            // Function to update the dashboard metrics
            const refreshDashboardMetrics = () => {
                const totalSales = allSalesEntries.reduce((sum, entry) => sum + (parseFloat(entry.totalRevenue) || 0), 0);
                const totalDue = allSalesEntries.reduce((sum, entry) => sum + (parseFloat(entry.due) || 0), 0);
                const uniqueStores = new Set(allSalesEntries.map(entry => entry.storeName)).size;
                
                totalSalesEl.textContent = `BDT ${totalSales.toFixed(2)}`;
                totalDueEl.textContent = `BDT ${totalDue.toFixed(2)}`;
                totalShopsEl.textContent = uniqueStores;
            };
        
            // Function to render all charts
            const renderCharts = () => {
                const colors = getChartColors();
                
                // Destroy existing charts to prevent memory leaks and redraw issues
                if (revenueChart) revenueChart.destroy();
                if (gadgetSalesChart) gadgetSalesChart.destroy();
                if (storeSalesChart) storeSalesChart.destroy();
        
                const revenueData = prepareRevenueData();
                const gadgetData = prepareGadgetSalesData();
                const storeData = prepareStoreSalesData();
        
                // Revenue by Date Chart
                const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: revenueData.labels,
                        datasets: [
                            {
                                label: 'Total Revenue (BDT)',
                                data: revenueData.data,
                                borderColor: colors.colors[0],
                                backgroundColor: 'rgba(61, 116, 182, 0.2)',
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: colors.colors[0]
                            },
                            {
                                label: 'Trend Line',
                                data: revenueData.trendlineData,
                                borderColor: 'rgba(255, 99, 132, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                tension: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { labels: { color: colors.textColor } } },
                        scales: {
                            x: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            },
                            y: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            }
                        }
                    }
                });
        
                // Top Gadgets Chart (Doughnut)
                const gadgetCtx = document.getElementById('gadget-sales-chart').getContext('2d');
                gadgetSalesChart = new Chart(gadgetCtx, {
                    type: 'doughnut',
                    data: {
                        labels: gadgetData.labels,
                        datasets: [{
                            data: gadgetData.data,
                            backgroundColor: colors.colors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'right', labels: { color: colors.textColor } } }
                    }
                });
        
                // Sales by Store Chart (Bar)
                const storeCtx = document.getElementById('store-sales-chart').getContext('2d');
                storeSalesChart = new Chart(storeCtx, {
                    type: 'bar',
                    data: {
                        labels: storeData.labels,
                        datasets: [{
                            label: 'Number of Sales',
                            data: storeData.data,
                            backgroundColor: colors.colors,
                            borderColor: colors.colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            },
                            y: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            }
                        }
                    }
                });
            };
        
            // Toggle between form view and dashboard view
            toggleViewBtn.addEventListener('click', () => {
                if (formView.classList.contains('hidden')) {
                    formView.classList.remove('hidden');
                    dashboardView.classList.add('hidden');
                    toggleViewBtn.textContent = 'Switch to Dashboard';
                } else {
                    formView.classList.add('hidden');
                    dashboardView.classList.remove('hidden');
                    toggleViewBtn.textContent = 'Switch to Form';
                    renderCharts(); // Render charts when the dashboard is visible
                }
            });
        
            // --- Initialization ---
            const initializeApp = () => {
                allSalesEntries = loadDataFromLocalStorage(SALES_KEY, []);
                allStoreNames = loadDataFromLocalStorage(STORES_KEY, ['Hasan Tel', 'Classic Mobile', 'Big Rock', 'Shahenshah Gadgets', 'Students Gadgets', 'Phone Store', 'Telephonic', 'Rakib Telecom', 'i-Club', 'Navigation Center', 'Talha Telecom', 'Kajol Electronics', 'Talukdar Telecom', 'Company Store', 'Talukdar Telecom 2', 'Samart Sec & Tech', 'Bismillah Telecom', 'Sajol Telecom']);
                allGadgetTypes = loadDataFromLocalStorage(GADGETS_KEY, ['Phone Charger', 'Ear Buds', 'USB Cable', 'Ear Phone']);
                offlineQueue = loadDataFromLocalStorage(OFFLINE_QUEUE_KEY, []);
                loadDropdowns();
                calculateTotalRevenue();
                renderData(allSalesEntries);
                refreshDashboardMetrics();
                syncOfflineData();
            };
        
            initializeApp();
        });
        
    </script>
    <script>
        /*!
         * Chart.js v3.7.0
         * http://chartjs.org/
         *
         * Copyright 2021 Chart.js Contributors
         * Released under the MIT license
         * https://github.com/chartjs/Chart.js/blob/master/LICENSE.md
         */
        !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Chart=e()}(this,(function(){"use strict";const t=new Uint8Array(16);function e(){if(!this.crypto||!this.crypto.getRandomValues){return(""+1e7+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(t=>(""+t^255&Math.random()*16>>t/4).toString(16)))}(this.crypto.getRandomValues(t));return(""+1e7+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(t[e]^15>>e/4).toString(16)))}})})}));
        </script>
</body>
</html>
