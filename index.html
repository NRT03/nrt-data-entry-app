<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N.R.T.</title>
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(
                    registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    },
                    err => {
                        console.log('Service Worker registration failed:', err);
                    }
                );
            });
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom styles for the app */
        .manage-toggle-btn {
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .manage-toggle-btn:hover {
            transform: scale(1.1);
        }
        .editable-item {
            cursor: pointer;
            outline: none;
            border-bottom: 1px dashed transparent;
        }
        .editable-item:focus {
            border-bottom: 1px dashed #3d74b6;
        }
        /* Custom modal for alerts */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-box {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            text-align: center;
        }
        .invalid-field {
            border-color: #ef4444 !important; /* Red border for invalid fields */
        }
        /* Custom notification style */
        .notification-container {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .notification {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            animation: fadeInOut 4s forwards;
        }
        .notification.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .notification.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        /* New style for the signature box */
        .signature-box {
            border: 1px solid #000;
            width: 150px;
            height: 60px;
            position: relative;
            margin-top: 1rem;
        }
        .signature-box::before {
            content: 'Signature';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #4b5563;
        }
        
        /* New receipt styles */
        .receipt-container {
            width: 350px;
            background-color: white;
            padding: 1rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .receipt-header {
            text-align: center;
            border-bottom: 2px dashed #000;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .receipt-header h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .receipt-header p {
            font-size: 0.875rem;
        }
        .receipt-details p {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        .receipt-details strong {
            font-weight: 600;
        }
        .receipt-total {
            border-top: 2px dashed #000;
            margin-top: 1rem;
            padding-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.125rem;
            font-weight: bold;
        }
        .receipt-signature-box {
            border-top: 1px solid #000;
            text-align: center;
            margin-top: 2rem;
            padding-top: 0.5rem;
        }
        .receipt-signature-box p {
            font-size: 0.75rem;
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <div class="notification-container"></div>
    <div id="custom-modal" class="modal-overlay hidden">
        <div class="modal-box dark:bg-gray-800">
            <h4 id="modal-title" class="text-xl font-bold text-gray-900 dark:text-gray-50">Alert</h4>
            <p id="modal-text" class="mt-4 text-gray-700 dark:text-gray-300">This is a custom alert.</p>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="modal-confirm-btn" class="px-4 py-2 bg-[#3d74b6] hover:bg-[#2d5f99] text-white rounded-md font-semibold">OK</button>
            </div>
        </div>
    </div>
    
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-6 border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-extrabold text-gray-900 dark:text-gray-50">N.R.T.</h1>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400" id="tagline">Record an Achievement</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="toggle-view-btn" class="px-4 py-2 bg-[#3d74b6] hover:bg-[#2d5f99] rounded-md text-white font-semibold shadow-lg transform transition duration-200 hover:scale-105">
                        Switch to Dashboard
                    </button>
                </div>
            </div>

            <div id="main-content-container">
                <div id="form-view" class="space-y-6">
                    <form id="sales-form" class="space-y-4">
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Date <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="date" name="date" required
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50 focus:ring-[#3d74b6] focus:border-[#3d74b6] transition duration-150">
                        </div>
                        <div>
                            <div class="flex items-center justify-between">
                                <label for="storeName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Store Name <span class="text-red-500">*</span>
                                </label>
                                <button type="button" id="manage-stores-toggle" class="manage-toggle-btn text-[#3d74b6] hover:text-[#2d5f99]">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 20h9"></path>
                                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                                    </svg>
                                </button>
                            </div>
                            <select id="storeName" name="storeName" required
                                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50 focus:ring-[#3d74b6] focus:border-[#3d74b6] transition duration-150">
                                <option value="" disabled selected>Select a store</option>
                                </select>
                            <div id="manage-stores-container" class="mt-4 space-y-4 hidden">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-50">Manage Store Names</h3>
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="new-store-input" placeholder="Search or add a store name"
                                        class="flex-1 rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50">
                                    <button type="button" id="add-store-btn"
                                        class="px-4 py-2 bg-[#eac8a6] hover:bg-[#d6b797] rounded-md text-white font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        Add
                                    </button>
                                </div>
                                <div id="store-list" class="space-y-2"></div>
                            </div>
                        </div>
                        <div>
                            <label for="mobileNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Mobile Number <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" id="mobileNumber" name="mobileNumber" required placeholder="e.g., 01712345678"
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50 focus:ring-[#3d74b6] focus:border-[#3d74b6] transition duration-150">
                            <p id="mobile-error" class="mt-1 text-sm text-red-500 hidden">Please enter a valid 11-digit mobile number.</p>
                        </div>
                        <div>
                            <label for="invoiceNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Invoice Number <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="invoiceNumber" name="invoiceNumber" required placeholder="e.g., INV-00123"
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50 focus:ring-[#3d74b6] focus:border-[#3d74b6] transition duration-150">
                        </div>
                        <div>
                            <div class="flex items-center justify-between">
                                <label for="gadgetType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Gadget Type <span class="text-red-500">*</span>
                                </label>
                                <button type="button" id="manage-gadgets-toggle" class="manage-toggle-btn text-[#3d74b6] hover:text-[#2d5f99]">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 20h9"></path>
                                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                                    </svg>
                                </button>
                            </div>
                            <select id="gadgetType" name="gadgetType" required
                                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50 focus:ring-[#3d74b6] focus:border-[#3d74b6] transition duration-150">
                                <option value="" disabled selected>Select a gadget type</option>
                                </select>
                            <div id="manage-gadgets-container" class="mt-4 space-y-4 hidden">
                                 <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-50">Manage Gadget Types</h3>
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="new-gadget-input" placeholder="Search or add a gadget type"
                                        class="flex-1 rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50">
                                    <button type="button" id="add-gadget-btn"
                                        class="px-4 py-2 bg-[#eac8a6] hover:bg-[#d6b797] rounded-md text-white font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        Add
                                    </button>
                                </div>
                                <div id="gadget-list" class="space-y-2"></div>
                            </div>
                        </div>
                        <div>
                            <label for="modelName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Model Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="modelName" name="modelName" required placeholder="e.g., iPhone 15 Pro"
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50 focus:ring-[#3d74b6] focus:border-[#3d74b6] transition duration-150">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Quantity <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="quantity" name="quantity" required min="1" value="1"
                                       class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50 focus:ring-[#3d74b6] focus:border-[#3d74b6] transition duration-150">
                            </div>
                            
                            <div>
                                <label for="sellingPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Selling Price (BDT) <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="sellingPrice" name="sellingPrice" required min="0" step="0.01" placeholder="e.g., 999.99"
                                       class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50 focus:ring-[#3d74b6] focus:border-[#3d74b6] transition duration-150">
                            </div>

                            <div>
                                <label for="totalRevenue" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Total
                                </label>
                                <input type="number" id="totalRevenue" name="totalRevenue" readonly value="0.00"
                                       class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50 cursor-not-allowed">
                            </div>
                        </div>
                        
                        <div>
                            <label for="due" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Due (optional)</label>
                            <input type="number" id="due" name="due" min="0" step="0.01" placeholder="e.g., 50.00"
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50 focus:ring-[#3d74b6] focus:border-[#3d74b6] transition duration-150">
                        </div>

                        <div class="flex items-center mt-2">
                            <input type="checkbox" id="keep-shop-info" class="h-4 w-4 text-[#3d74b6] focus:ring-[#3d74b6] border-gray-300 rounded">
                            <label for="keep-shop-info" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Keep Shop Name and Mobile Number</label>
                        </div>

                        <div class="flex space-x-4">
                            <button type="submit" id="submit-btn"
                                    class="flex-1 py-3 px-4 bg-[#3d74b6] hover:bg-[#2d5f99] rounded-md text-white font-semibold text-lg shadow-lg transform transition duration-200 hover:scale-105">
                                Submit
                            </button>
                            <button type="button" id="clear-form-btn"
                                    class="flex-1 py-3 px-4 bg-[#eac8a6] hover:bg-[#d6b797] rounded-md text-white font-semibold text-lg shadow-lg transform transition duration-200 hover:scale-105">
                                Clear Form
                            </button>
                            <button type="button" id="cancel-edit-btn"
                                    class="flex-1 py-3 px-4 bg-[#dc3c22] hover:bg-[#b0301a] rounded-md text-white font-semibold text-lg shadow-lg transform transition duration-200 hover:scale-105 hidden">
                                Cancel Edit
                            </button>
                        </div>
                    </form>

                    <div id="data-display" class="mt-8">
                        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50">Saved Entries</h2>
                        <div class="flex items-center space-x-2 mt-4">
                            <input type="text" id="search-input" placeholder="Search by mobile, invoice, store, or date"
                                   class="flex-1 rounded-md border-gray-300 dark:border-gray-600 shadow-sm p-3 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-50">
                            <button type="button" id="clear-search-btn"
                                    class="px-4 py-2 bg-[#dc3c22] hover:bg-[#b0301a] rounded-md text-white font-semibold">Clear</button>
                        </div>
                        <div class="flex justify-between space-x-2 mt-4">
                             <button type="button" id="view-dues-btn"
                                    class="flex-1 py-2 px-4 bg-[#fbf5de] hover:bg-[#e6e0cc] rounded-md text-gray-800 font-semibold">
                                View Dues
                            </button>
                            <button type="button" id="export-btn"
                                    class="flex-1 py-2 px-4 bg-[#eac8a6] hover:bg-[#d6b797] rounded-md text-white font-semibold">
                                Export Data
                            </button>
                        </div>
                        <div id="entries-list" class="mt-4 space-y-4">
                            <p class="text-gray-500 dark:text-gray-400">No entries saved yet.</p>
                        </div>
                    </div>
                </div>

                <div id="dashboard-view" class="hidden">
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
                        <div class="bg-[#eac8a6] dark:bg-[#d6b797] p-6 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-gray-800 dark:text-gray-200">Total Revenue</p>
                            <p id="total-sales" class="mt-1 text-3xl font-bold text-gray-900 dark:text-gray-100">BDT 0.00</p>
                        </div>
                        <div class="bg-[#fbf5de] dark:bg-[#e6e0cc] p-6 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-gray-800 dark:text-gray-200">Outstanding Due</p>
                            <p id="total-due" class="mt-1 text-3xl font-bold text-gray-900 dark:text-gray-100">BDT 0.00</p>
                        </div>
                        <div class="bg-[#dc3c22] dark:bg-[#b0301a] p-6 rounded-lg shadow-md">
                            <p class="text-sm font-medium text-white dark:text-gray-200">Total Shops</p>
                            <p id="total-shops" class="mt-1 text-3xl font-bold text-white dark:text-gray-100">0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-50 mb-4">Total Revenue by Date</h3>
                            <canvas id="revenue-chart"></canvas>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-50 mb-4">Top Gadgets</h3>
                            <canvas id="gadget-sales-chart"></canvas>
                         </div>
                         <div class="md:col-span-2 bg-gray-50 dark:bg-gray-700 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-50 mb-4">Sales by Store</h3>
                            <canvas id="store-sales-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Keys for Local Storage
            const SALES_KEY = 'chinoMartSales';
            const STORES_KEY = 'chinoMartStores';
            const GADGETS_KEY = 'chinoMartGadgets';
            const OFFLINE_QUEUE_KEY = 'chinoMartOfflineQueue';
            const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwOyZ_ehxURDo1giZ9eFI1fMZnxkhzUOTFIJkGAze2YDU4xDoRACSaTW1uNdsFNHHBH/exec';

            // Helper function to save data to Local Storage
            const saveDataToLocalStorage = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving to Local Storage', e);
                    showNotification('Could not save data to your device. Local Storage might be full or disabled.', 'error');
                }
            };

            // Helper function to load data from Local Storage
            const loadDataFromLocalStorage = (key, defaultData) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultData;
                } catch (e) {
                    console.error('Error loading from Local Storage', e);
                    return defaultData;
                }
            };

            // State for the application, loaded from Local Storage
            let allSalesEntries = loadDataFromLocalStorage(SALES_KEY, []);
            let allStoreNames = loadDataFromLocalStorage(STORES_KEY, ['Hasan Tel', 'Classic Mobile', 'Big Rock', 'Shahenshah Gadgets', 'Students Gadgets', 'Phone Store', 'Telephonic', 'Rakib Telecom', 'i-Club', 'Navigation Center', 'Talha Telecom', 'Kajol Electronics', 'Talukdar Telecom', 'Company Store', 'Talukdar Telecom 2', 'Samart Sec & Tech', 'Bismillah Telecom', 'Sajol Telecom']);
            let allGadgetTypes = loadDataFromLocalStorage(GADGETS_KEY, ['Phone Charger', 'Ear Buds', 'USB Cable', 'Ear Phone']);
            let offlineQueue = loadDataFromLocalStorage(OFFLINE_QUEUE_KEY, []);
            let editingIndex = -1; // -1 means no entry is being edited

            // DOM elements
            const form = document.getElementById('sales-form');
            const entriesList = document.getElementById('entries-list');
            const quantityInput = document.getElementById('quantity');
            const sellingPriceInput = document.getElementById('sellingPrice');
            const totalRevenueInput = document.getElementById('totalRevenue');
            const exportBtn = document.getElementById('export-btn');
            const manageStoresToggleBtn = document.getElementById('manage-stores-toggle');
            const manageStoresContainer = document.getElementById('manage-stores-container');
            const newStoreInput = document.getElementById('new-store-input');
            const addStoreBtn = document.getElementById('add-store-btn');
            const storeList = document.getElementById('store-list');
            const manageGadgetsToggleBtn = document.getElementById('manage-gadgets-toggle');
            const manageGadgetsContainer = document.getElementById('manage-gadgets-container');
            const newGadgetInput = document.getElementById('new-gadget-input');
            const addGadgetBtn = document.getElementById('add-gadget-btn');
            const storeSelect = document.getElementById('storeName');
            const gadgetSelect = document.getElementById('gadgetType');
            const gadgetList = document.getElementById('gadget-list');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const customModal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const notificationContainer = document.querySelector('.notification-container');
            const toggleViewBtn = document.getElementById('toggle-view-btn');
            const formView = document.getElementById('form-view');
            const dashboardView = document.getElementById('dashboard-view');
            const submitBtn = document.getElementById('submit-btn');
            const clearFormBtn = document.getElementById('clear-form-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const viewDuesBtn = document.getElementById('view-dues-btn');
            const dateInput = document.getElementById('date');
            const mobileNumberInput = document.getElementById('mobileNumber');
            const keepShopInfoCheckbox = document.getElementById('keep-shop-info');

            // Dashboard Metrics
            const totalSalesEl = document.getElementById('total-sales');
            const totalDueEl = document.getElementById('total-due');
            const totalShopsEl = document.getElementById('total-shops');

            // Chart.js chart instances
            let revenueChart, gadgetSalesChart, storeSalesChart;

            // Helper function for custom alerts
            const customAlert = (message, onConfirmCallback = () => {}) => {
                modalTitle.textContent = 'Alert';
                modalText.textContent = message;
                customModal.classList.remove('hidden');
                modalConfirmBtn.onclick = () => {
                    customModal.classList.add('hidden');
                    onConfirmCallback();
                };
            };
            
            // Show a temporary notification
            const showNotification = (message, type = 'success') => {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notificationContainer.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 4000); // Notification disappears after 4 seconds
            };

            // Load theme from system preference
            const loadTheme = () => {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            };
            
            loadTheme();
            
            // Load and populate dropdowns from the local data
            const loadDropdowns = () => {
                storeSelect.innerHTML = '<option value="" disabled selected>Select a store</option>';
                allStoreNames.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    storeSelect.appendChild(option);
                });

                gadgetSelect.innerHTML = '<option value="" disabled selected>Select a gadget type</option>';
                allGadgetTypes.sort().forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    gadgetSelect.appendChild(option);
                });
            };

            // Render the management lists with edit and delete buttons
            const renderManagementList = (inputElement, listElement, items, type) => {
                const query = inputElement.value.toLowerCase();
                listElement.innerHTML = '';
                
                const filteredItems = items.filter(item => item.toLowerCase().includes(query));

                if (filteredItems.length === 0 && query !== '') {
                    listElement.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">No results found for "${query}".</p>`;
                } else if (filteredItems.length > 0) {
                    filteredItems.forEach(item => {
                        const listItem = document.createElement('div');
                        listItem.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                        listItem.innerHTML = `
                            <span contenteditable="true" class="editable-item text-gray-900 dark:text-gray-50 px-2 py-1" data-old-value="${item}">${item}</span>
                            <div>
                                <button type="button" class="delete-item-btn text-[#dc3c22] hover:text-[#b0301a] ml-2" data-item="${item}" data-type="${type}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 0 0 1-2-2V6"></path>
                                        <path d="M8 6V4a2 0 0 1 2-2h4a2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </div>
                        `;
                        listElement.appendChild(listItem);
                    });
                }
                
                listElement.querySelectorAll('.editable-item').forEach(itemSpan => {
                    itemSpan.addEventListener('blur', (e) => {
                        const oldItem = e.target.getAttribute('data-old-value');
                        const newItem = e.target.textContent.trim();
                        const isStore = type === 'store';
                        
                        if (newItem === '' || newItem === oldItem) {
                            e.target.textContent = oldItem;
                            return;
                        }
                        
                        const itemsArray = isStore ? allStoreNames : allGadgetTypes;
                        if (itemsArray.map(i => i.toLowerCase()).includes(newItem.toLowerCase())) {
                            customAlert(`"${newItem}" already exists. Please use a different name.`);
                            e.target.textContent = oldItem;
                            return;
                        }
                        
                        const index = itemsArray.indexOf(oldItem);
                        if (index > -1) {
                            itemsArray[index] = newItem;
                        }
                        
                        e.target.setAttribute('data-old-value', newItem);
                        
                        if (isStore) {
                            saveDataToLocalStorage(STORES_KEY, allStoreNames);
                        } else {
                            saveDataToLocalStorage(GADGETS_KEY, allGadgetTypes);
                        }
                        
                        loadDropdowns();
                        showNotification(`${oldItem} was updated to ${newItem}!`);
                    });
                });
                
                listElement.querySelectorAll('.delete-item-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const itemToDelete = e.target.getAttribute('data-item') || e.target.closest('button').getAttribute('data-item');
                        const isStore = e.target.getAttribute('data-type') === 'store' || e.target.closest('button').getAttribute('data-type') === 'store';
                        
                        customAlert(`Are you sure you want to delete "${itemToDelete}"?`, () => {
                            if (isStore) {
                                allStoreNames = allStoreNames.filter(name => name !== itemToDelete);
                                saveDataToLocalStorage(STORES_KEY, allStoreNames);
                                loadDropdowns();
                                renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                            } else {
                                allGadgetTypes = allGadgetTypes.filter(name => name !== itemToDelete);
                                saveDataToLocalStorage(GADGETS_KEY, allGadgetTypes);
                                loadDropdowns();
                                renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                            }
                            showNotification(`${itemToDelete} deleted successfully!`);
                        });
                    });
                });
            };

            const updateAddButtonState = (inputElement, buttonElement, items) => {
                const inputValue = inputElement.value.trim();
                const itemExists = items.map(item => item.toLowerCase()).includes(inputValue.toLowerCase());
                
                if (inputValue === '' || itemExists) {
                    buttonElement.disabled = true;
                } else {
                    buttonElement.disabled = false;
                }
            };
            
            addStoreBtn.addEventListener('click', () => {
                const newStore = newStoreInput.value.trim();
                if (newStore && !allStoreNames.map(name => name.toLowerCase()).includes(newStore.toLowerCase())) {
                    allStoreNames.push(newStore);
                    newStoreInput.value = '';
                    saveDataToLocalStorage(STORES_KEY, allStoreNames);
                    loadDropdowns();
                    renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                    updateAddButtonState(newStoreInput, addStoreBtn, allStoreNames);
                    showNotification('New store added!');
                } else {
                    customAlert(`"${newStore}" already exists or is invalid.`);
                }
            });

            addGadgetBtn.addEventListener('click', () => {
                const newGadget = newGadgetInput.value.trim();
                if (newGadget && !allGadgetTypes.map(type => type.toLowerCase()).includes(newGadget.toLowerCase())) {
                    allGadgetTypes.push(newGadget);
                    newGadgetInput.value = '';
                    saveDataToLocalStorage(GADGETS_KEY, allGadgetTypes);
                    loadDropdowns();
                    renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                    updateAddButtonState(newGadgetInput, addGadgetBtn, allGadgetTypes);
                    showNotification('New gadget type added!');
                } else {
                    customAlert(`"${newGadget}" already exists or is invalid.`);
                }
            });

            newStoreInput.addEventListener('input', () => {
                renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                updateAddButtonState(newStoreInput, addStoreBtn, allStoreNames);
            });
            newGadgetInput.addEventListener('input', () => {
                renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                updateAddButtonState(newGadgetInput, addGadgetBtn, allGadgetTypes);
            });

            manageStoresToggleBtn.addEventListener('click', () => {
                manageStoresContainer.classList.toggle('hidden');
                if (!manageStoresContainer.classList.contains('hidden')) {
                    renderManagementList(newStoreInput, storeList, allStoreNames, 'store');
                    updateAddButtonState(newStoreInput, addStoreBtn, allStoreNames);
                }
            });
            manageGadgetsToggleBtn.addEventListener('click', () => {
                manageGadgetsContainer.classList.toggle('hidden');
                if (!manageGadgetsContainer.classList.contains('hidden')) {
                    renderManagementList(newGadgetInput, gadgetList, allGadgetTypes, 'gadget');
                    updateAddButtonState(newGadgetInput, addGadgetBtn, allGadgetTypes);
                }
            });

            const calculateTotalRevenue = () => {
                const quantity = parseFloat(quantityInput.value) || 0;
                const sellingPrice = parseFloat(sellingPriceInput.value) || 0;
                const totalRevenue = quantity * sellingPrice;
                totalRevenueInput.value = totalRevenue.toFixed(2);
            };

            quantityInput.addEventListener('input', calculateTotalRevenue);
            sellingPriceInput.addEventListener('input', calculateTotalRevenue);
            
            const downloadAsJpeg = (entry, filename) => {
                const receiptHtml = `
                    <div class="receipt-container">
                        <div class="receipt-header">
                            <h1>ChinoMart BD</h1>
                            <p>Money Receipt</p>
                        </div>
                        <div class="receipt-details">
                            <p><strong>Date:</strong> ${entry.date}</p>
                            <p><strong>Store:</strong> ${entry.storeName}</p>
                            <p><strong>Mobile:</strong> ${entry.mobileNumber}</p>
                            <p><strong>Invoice:</strong> ${entry.invoiceNumber}</p>
                            <p><strong>Gadget:</strong> ${entry.gadgetType} - ${entry.modelName}</p>
                            <p><strong>Quantity:</strong> ${entry.quantity}</p>
                            <p><strong>Price:</strong> BDT ${parseFloat(entry.sellingPrice).toFixed(2)}</p>
                        </div>
                        <div class="receipt-total">
                            <p><strong>Total:</strong> BDT ${parseFloat(entry.totalRevenue).toFixed(2)}</p>
                            <p><strong>Due:</strong> ${entry.due && parseFloat(entry.due) > 0 ? `<span class="text-[#dc3c22]">BDT ${parseFloat(entry.due).toFixed(2)}</span>` : 'Paid'}</p>
                        </div>
                        <div class="receipt-signature-box">
                            <p>Signature</p>
                        </div>
                    </div>
                `;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = receiptHtml;
                document.body.appendChild(tempDiv);
                
                const receiptElement = tempDiv.querySelector('.receipt-container');

                html2canvas(receiptElement, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    showNotification('Receipt downloaded as JPEG!');
                    
                    // Clean up the temporary element
                    tempDiv.remove();
                }).catch(error => {
                    console.error('Error generating JPEG:', error);
                    showNotification('Could not download the receipt. Please try again.', 'error');
                    
                    // Clean up in case of error as well
                    tempDiv.remove();
                });
            };

            const renderData = (data) => {
                entriesList.innerHTML = '';
                
                if (data.length === 0) {
                    entriesList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No matching entries found.</p>';
                    return;
                }

                data.forEach((entry, index) => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start';
                    entryDiv.innerHTML = `
                        <div>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Date:</strong> ${entry.date}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Store:</strong> ${entry.storeName}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Mobile:</strong> ${entry.mobileNumber}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Invoice:</strong> ${entry.invoiceNumber}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Gadget:</strong> ${entry.gadgetType} - ${entry.modelName}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Quantity:</strong> ${entry.quantity}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Price:</strong> BDT ${entry.sellingPrice}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Total:</strong> BDT ${entry.totalRevenue}</p>
                            <p class="text-sm text-gray-800 dark:text-gray-200"><strong>Due:</strong> ${entry.due && parseFloat(entry.due) > 0 ? `<span class="text-[#dc3c22] font-bold">BDT ${parseFloat(entry.due).toFixed(2)}</span>` : 'Paid'}</p>
                        </div>
                        <div class="flex space-x-2 mt-4 sm:mt-0">
                             <button type="button" class="download-jpeg-btn px-2 py-1 bg-[#3d74b6] hover:bg-[#2d5f99] rounded-md text-white text-xs font-semibold" data-index="${index}">
                                Download as JPEG
                            </button>
                             <button type="button" class="edit-btn px-2 py-1 bg-[#eac8a6] hover:bg-[#d6b797] rounded-md text-white text-xs font-semibold" data-index="${index}">
                                Edit
                            </button>
                            <button type="button" class="delete-btn px-2 py-1 bg-[#dc3c22] hover:bg-[#b0301a] rounded-md text-white text-xs font-semibold" data-index="${index}">
                                Delete
                            </button>
                        </div>
                    `;
                    entriesList.appendChild(entryDiv);
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToDelete = parseInt(e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index'));
                        customAlert('Are you sure you want to delete this sales entry?', () => {
                            allSalesEntries.splice(indexToDelete, 1);
                            saveDataToLocalStorage(SALES_KEY, allSalesEntries);
                            renderData(allSalesEntries);
                            refreshDashboardMetrics();
                            showNotification('Entry deleted successfully!');
                            if (dashboardView.classList.contains('hidden') === false) {
                                renderCharts();
                            }
                        });
                    });
                });
                
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToEdit = parseInt(e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index'));
                        const entry = allSalesEntries[indexToEdit];
                        
                        editingIndex = indexToEdit;
                        
                        // Populate the form with the entry's data
                        dateInput.value = entry.date;
                        storeSelect.value = entry.storeName;
                        document.getElementById('mobileNumber').value = entry.mobileNumber;
                        document.getElementById('invoiceNumber').value = entry.invoiceNumber;
                        gadgetSelect.value = entry.gadgetType;
                        document.getElementById('modelName').value = entry.modelName;
                        quantityInput.value = entry.quantity;
                        sellingPriceInput.value = entry.sellingPrice;
                        totalRevenueInput.value = entry.totalRevenue;
                        document.getElementById('due').value = entry.due;
                        
                        // Change button text and visibility
                        submitBtn.textContent = 'Update Entry';
                        cancelEditBtn.classList.remove('hidden');
                        
                        // Scroll to the top of the form
                        form.scrollIntoView({ behavior: 'smooth' });
                    });
                });
                
                document.querySelectorAll('.download-jpeg-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const indexToDownload = parseInt(e.target.getAttribute('data-index') || e.target.closest('button').getAttribute('data-index'));
                        const entry = allSalesEntries[indexToDownload];
                        const filename = `receipt-${entry.invoiceNumber || entry.date}.jpeg`;
                        downloadAsJpeg(entry, filename);
                    });
                });
            };

            const clearForm = () => {
                const dateVal = dateInput.value;
                const storeVal = storeSelect.value;
                const mobileVal = mobileNumberInput.value;

                form.reset();
                dateInput.value = dateVal;

                if (keepShopInfoCheckbox.checked) {
                    storeSelect.value = storeVal;
                    mobileNumberInput.value = mobileVal;
                } else {
                    storeSelect.value = ""; // Reset to default "Select a store"
                    mobileNumberInput.value = "";
                }
                
                calculateTotalRevenue();
                
                // If in edit mode, revert to add mode
                if (editingIndex !== -1) {
                    editingIndex = -1;
                    submitBtn.textContent = 'Submit';
                    cancelEditBtn.classList.add('hidden');
                }
            };
            
            clearFormBtn.addEventListener('click', clearForm);
            cancelEditBtn.addEventListener('click', clearForm);

            const viewDues = () => {
                const dueEntries = allSalesEntries.filter(entry => parseFloat(entry.due) > 0);
                renderData(dueEntries);
            };

            viewDuesBtn.addEventListener('click', viewDues);

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                if (query === '') {
                    renderData(allSalesEntries);
                } else {
                    const filteredData = allSalesEntries.filter(entry =>
                        (entry.mobileNumber && entry.mobileNumber.toLowerCase().includes(query)) ||
                        (entry.invoiceNumber && entry.invoiceNumber.toLowerCase().includes(query)) ||
                        (entry.storeName && entry.storeName.toLowerCase().includes(query)) ||
                        (entry.date && entry.date.toLowerCase().includes(query))
                    );
                    renderData(filteredData);
                }
            });

            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                renderData(allSalesEntries);
            });

            const exportToCsv = () => {
                if (allSalesEntries.length === 0) {
                    showNotification("There is no data to export!", 'error');
                    return;
                }
                
                const headers = ["Date", "StoreName", "MobileNumber", "InvoiceNumber", "GadgetType", "ModelName", "Quantity", "SellingPrice", "TotalRevenue", "Due"];
                const keys = ["date", "storeName", "mobileNumber", "invoiceNumber", "gadgetType", "modelName", "quantity", "sellingPrice", "totalRevenue", "due"];
                
                const csvRows = [];
                csvRows.push(headers.join(','));

                for (const row of allSalesEntries) {
                    const values = keys.map(key => {
                        const value = row[key] !== undefined ? row[key] : '';
                        const escaped = ('' + value).replace(/"/g, '""');
                        return `"${escaped}"`;
                    });
                    csvRows.push(values.join(','));
                }

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'nrt_sales_data.csv';
                link.click();
            };
            
            exportBtn.addEventListener('click', exportToCsv);

            const validateForm = () => {
                let isValid = true;
                const requiredInputs = form.querySelectorAll('[required]');
                const mobileNumberInput = document.getElementById('mobileNumber');
                const mobileNumberError = document.getElementById('mobile-error');

                requiredInputs.forEach(input => {
                    if (input.value.trim() === '' || (input.tagName === 'SELECT' && input.value === '')) {
                        input.classList.add('invalid-field');
                        isValid = false;
                    } else {
                        input.classList.remove('invalid-field');
                    }
                });

                const mobileNumberValue = mobileNumberInput.value.trim();
                if (mobileNumberValue.length !== 11 || !/^\d{11}$/.test(mobileNumberValue)) {
                    mobileNumberInput.classList.add('invalid-field');
                    mobileNumberError.classList.remove('hidden');
                    isValid = false;
                } else {
                    mobileNumberInput.classList.remove('invalid-field');
                    mobileNumberError.classList.add('hidden');
                }

                return isValid;
            };

            const sendDataToGoogleSheet = async (data) => {
                try {
                    await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    return true;
                } catch (error) {
                    console.error('Error sending data to Google Sheet:', error);
                    return false;
                }
            };
            
            const syncOfflineData = async () => {
                if (navigator.onLine && offlineQueue.length > 0) {
                    showNotification(`Internet connection restored. Syncing ${offlineQueue.length} offline entries...`, 'success');
                    
                    const successfullySynced = [];
                    for (const entry of offlineQueue) {
                        const success = await sendDataToGoogleSheet(entry);
                        if (success) {
                            successfullySynced.push(entry);
                        }
                    }
                    
                    offlineQueue = offlineQueue.filter(entry => !successfullySynced.includes(entry));
                    saveDataToLocalStorage(OFFLINE_QUEUE_KEY, offlineQueue);

                    if (successfullySynced.length > 0) {
                        showNotification(`Synced ${successfullySynced.length} entries to Google Sheet!`, 'success');
                    }
                }
            };

            form.addEventListener('submit', (event) => {
                event.preventDefault();

                if (!validateForm()) {
                    showNotification('Please fill out all the required fields correctly.', 'error');
                    return;
                }
                
                const formData = new FormData(form);
                const newEntry = {};
                formData.forEach((value, key) => {
                    newEntry[key] = value;
                });
                
                newEntry.totalRevenue = totalRevenueInput.value;
                newEntry.due = newEntry.due || 0; // Ensure due is 0 if not provided
                
                // If we are editing, update the existing entry
                if (editingIndex !== -1) {
                    allSalesEntries[editingIndex] = newEntry;
                    showNotification('Entry updated successfully!');
                    editingIndex = -1; // Reset edit mode
                    submitBtn.textContent = 'Update Entry';
                    cancelEditBtn.classList.add('hidden');
                } else {
                    // Otherwise, add a new entry
                    allSalesEntries.push(newEntry);
                    showNotification('New entry added!');
                }

                saveDataToLocalStorage(SALES_KEY, allSalesEntries);

                if (navigator.onLine) {
                    sendDataToGoogleSheet(newEntry)
                        .then(success => {
                            if (success) {
                                showNotification('Data successfully sent to Google Sheet!', 'success');
                            } else {
                                offlineQueue.push(newEntry);
                                saveDataToLocalStorage(OFFLINE_QUEUE_KEY, offlineQueue);
                                showNotification('Failed to send data. Entry saved to offline queue.', 'error');
                            }
                        });
                } else {
                    offlineQueue.push(newEntry);
                    saveDataToLocalStorage(OFFLINE_QUEUE_KEY, offlineQueue);
                    showNotification('You are offline. Entry saved locally. Sync will happen automatically when online.', 'error');
                }
                
                // Keep date
                const lastDate = dateInput.value;
                
                // Keep store name and mobile if checkbox is checked
                const shouldKeepShopInfo = keepShopInfoCheckbox.checked;
                const lastStore = storeSelect.value;
                const lastMobileNumber = mobileNumberInput.value;

                form.reset();
                dateInput.value = lastDate;

                if (shouldKeepShopInfo) {
                    storeSelect.value = lastStore;
                    mobileNumberInput.value = lastMobileNumber;
                } else {
                    storeSelect.value = ""; // Reset to default "Select a store"
                }

                calculateTotalRevenue();

                renderData(allSalesEntries);
                refreshDashboardMetrics();
                if (dashboardView.classList.contains('hidden') === false) {
                    renderCharts();
                }
            });

            window.addEventListener('online', () => {
                syncOfflineData();
            });

            // NEW: Dashboard and Charting Functions

            // Helper function to get theme-appropriate colors
            const getChartColors = () => {
                const isDarkMode = document.documentElement.classList.contains('dark');
                return {
                    textColor: isDarkMode ? '#f3f4f6' : '#1f2937',
                    gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                    chartBg: isDarkMode ? '#1f2937' : '#ffffff',
                    colors: [
                        '#3d74b6', '#fbf5de', '#eac8a6', '#dc3c22', '#6366f1', '#60a5fa', '#34d399', '#fcd34d', '#f87171'
                    ]
                };
            };
            
            // Function to calculate linear regression for trendline
            const getLinearRegression = (x, y) => {
                let n = x.length;
                let sum_x = 0, sum_y = 0, sum_xy = 0, sum_x2 = 0;
                for (let i = 0; i < n; i++) {
                    sum_x += x[i];
                    sum_y += y[i];
                    sum_xy += x[i] * y[i];
                    sum_x2 += x[i] * x[i];
                }
                
                let a = (n * sum_xy - sum_x * sum_y) / (n * sum_x2 - sum_x * sum_x);
                let b = (sum_y / n) - a * (sum_x / n);
                
                return { a, b }; // a = slope, b = y-intercept
            };

            // Prepare data for the revenue chart with trendline
            const prepareRevenueData = () => {
                const groupedData = allSalesEntries.reduce((acc, entry) => {
                    const date = entry.date;
                    const revenue = parseFloat(entry.totalRevenue) || 0;
                    acc[date] = (acc[date] || 0) + revenue;
                    return acc;
                }, {});

                const sortedDates = Object.keys(groupedData).sort();
                const revenues = sortedDates.map(date => groupedData[date]);
                
                // Calculate trendline data
                const dateIndices = sortedDates.map((d, i) => i);
                const { a, b } = getLinearRegression(dateIndices, revenues);
                const trendlineData = sortedDates.map((d, i) => a * i + b);

                return { labels: sortedDates, data: revenues, trendlineData: trendlineData };
            };

            // Prepare data for the top gadgets chart
            const prepareGadgetSalesData = () => {
                const groupedData = allSalesEntries.reduce((acc, entry) => {
                    const gadget = entry.gadgetType;
                    acc[gadget] = (acc[gadget] || 0) + 1;
                    return acc;
                }, {});
                
                // Sort by sales count and get top 5
                const sortedGadgets = Object.entries(groupedData).sort(([, a], [, b]) => b - a);
                const topGadgets = sortedGadgets.slice(0, 5);

                return { labels: topGadgets.map(g => g[0]), data: topGadgets.map(g => g[1]) };
            };

            // Prepare data for the store sales chart
            const prepareStoreSalesData = () => {
                const groupedData = allSalesEntries.reduce((acc, entry) => {
                    const store = entry.storeName;
                    acc[store] = (acc[store] || 0) + 1;
                    return acc;
                }, {});

                return { labels: Object.keys(groupedData), data: Object.values(groupedData) };
            };
            
            // Function to update the dashboard metrics
            const refreshDashboardMetrics = () => {
                const totalSales = allSalesEntries.reduce((sum, entry) => sum + (parseFloat(entry.totalRevenue) || 0), 0);
                const totalDue = allSalesEntries.reduce((sum, entry) => sum + (parseFloat(entry.due) || 0), 0);
                const uniqueStores = new Set(allSalesEntries.map(entry => entry.storeName)).size;
                
                totalSalesEl.textContent = `BDT ${totalSales.toFixed(2)}`;
                totalDueEl.textContent = `BDT ${totalDue.toFixed(2)}`;
                totalShopsEl.textContent = uniqueStores;
            };

            // Function to render all charts
            const renderCharts = () => {
                const colors = getChartColors();
                
                // Destroy existing charts to prevent memory leaks and redraw issues
                if (revenueChart) revenueChart.destroy();
                if (gadgetSalesChart) gadgetSalesChart.destroy();
                if (storeSalesChart) storeSalesChart.destroy();

                const revenueData = prepareRevenueData();
                const gadgetData = prepareGadgetSalesData();
                const storeData = prepareStoreSalesData();

                // Revenue by Date Chart
                const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: revenueData.labels,
                        datasets: [
                            {
                                label: 'Total Revenue (BDT)',
                                data: revenueData.data,
                                borderColor: colors.colors[0],
                                backgroundColor: 'rgba(61, 116, 182, 0.2)',
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: colors.colors[0]
                            },
                            {
                                label: 'Trend Line',
                                data: revenueData.trendlineData,
                                borderColor: 'rgba(255, 99, 132, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                fill: false,
                                tension: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { labels: { color: colors.textColor } } },
                        scales: {
                            x: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            },
                            y: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            }
                        }
                    }
                });

                // Top Gadgets Chart (Doughnut)
                const gadgetCtx = document.getElementById('gadget-sales-chart').getContext('2d');
                gadgetSalesChart = new Chart(gadgetCtx, {
                    type: 'doughnut',
                    data: {
                        labels: gadgetData.labels,
                        datasets: [{
                            data: gadgetData.data,
                            backgroundColor: colors.colors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'right', labels: { color: colors.textColor } } }
                    }
                });

                // Sales by Store Chart (Bar)
                const storeCtx = document.getElementById('store-sales-chart').getContext('2d');
                storeSalesChart = new Chart(storeCtx, {
                    type: 'bar',
                    data: {
                        labels: storeData.labels,
                        datasets: [{
                            label: 'Number of Sales',
                            data: storeData.data,
                            backgroundColor: colors.colors,
                            borderColor: colors.colors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            },
                            y: {
                                ticks: { color: colors.textColor },
                                grid: { color: colors.gridColor }
                            }
                        }
                    }
                });
            };

            // Toggle between form view and dashboard view
            toggleViewBtn.addEventListener('click', () => {
                if (formView.classList.contains('hidden')) {
                    formView.classList.remove('hidden');
                    dashboardView.classList.add('hidden');
                    toggleViewBtn.textContent = 'Switch to Dashboard';
                } else {
                    formView.classList.add('hidden');
                    dashboardView.classList.remove('hidden');
                    toggleViewBtn.textContent = 'Switch to Form';
                    renderCharts(); // Render charts when the dashboard is visible
                }
            });

            // --- Initialization ---
            const initializeApp = () => {
                allSalesEntries = loadDataFromLocalStorage(SALES_KEY, []);
                allStoreNames = loadDataFromLocalStorage(STORES_KEY, ['Hasan Tel', 'Classic Mobile', 'Big Rock', 'Shahenshah Gadgets', 'Students Gadgets', 'Phone Store', 'Telephonic', 'Rakib Telecom', 'i-Club', 'Navigation Center', 'Talha Telecom', 'Kajol Electronics', 'Talukdar Telecom', 'Company Store', 'Talukdar Telecom 2', 'Samart Sec & Tech', 'Bismillah Telecom', 'Sajol Telecom']);
                allGadgetTypes = loadDataFromLocalStorage(GADGETS_KEY, ['Phone Charger', 'Ear Buds', 'USB Cable', 'Ear Phone']);
                offlineQueue = loadDataFromLocalStorage(OFFLINE_QUEUE_KEY, []);
                loadDropdowns();
                calculateTotalRevenue();
                renderData(allSalesEntries);
                refreshDashboardMetrics();
                syncOfflineData();
            };

            initializeApp();
        });
    </script>
</body>
</html>
